<!DOCTYPE html>
<html lang="en"></html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBMCI One | Premium Analytics</title>
    <meta name="description" content="Premium analytics dashboard for DBMCI 360 - Track attendance, engagement, and performance metrics">
    <script type="module" src="firebase.js"></script>
    <script src="your-main-script.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        html:not(.dark) .glass {
            background: rgba(255, 255, 255, 0.85);
        }

        .sidebar-expanded { width: 220px; }
        .sidebar-collapsed { width: 100px; }

        .kpi-card {
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .kpi-card:hover {
            transform: translateY(-12px);
        }

        .kpi-card:hover .accent-line { 
            transform: scaleX(1); 
        }
        
        .kpi-card:hover .view-details { 
            opacity: 1; 
            transform: translateY(0); 
        }

        .kpi-card:hover .kpi-icon {
            transform: scale(1.1) rotate(3deg);
        }

        .kpi-card:hover .glow-orb {
            opacity: 0.2;
        }
        
        .accent-line {
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .view-details {
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .kpi-icon {
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .glow-orb {
            transition: opacity 0.5s ease;
        }

        ::-webkit-scrollbar { 
            width: 6px; 
        }
        ::-webkit-scrollbar-track { 
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, #6366f1, #a855f7);
            border-radius: 10px; 
        }

        @keyframes shine {
            0% { left: -100%; }
            100% { left: 200%; }
        }

        .shine-effect {
            position: relative;
            overflow: hidden;
        }

        .shine-effect::after {
            content: '';
            position: absolute;
            top: 0; 
            left: -100%;
            width: 50%; 
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
            transform: skewX(-25deg);
            animation: shine 5s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
            }
            50% { 
                box-shadow: 0 0 40px rgba(99, 102, 241, 0.5), 0 0 60px rgba(168, 85, 247, 0.3);
            }
        }

        .pulse-glow {
            animation: pulseGlow 2.5s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .float-animation {
            animation: float 4s ease-in-out infinite;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }

        .course-btn {
            position: relative;
            overflow: hidden;
        }

        .course-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .course-btn:hover::before {
            left: 100%;
        }

        select {
    appearance: none;
    /* Dark mode enhancements for inputs and selects */
html.dark select,
html.dark input[type="date"] {
    color-scheme: dark;
}

html.dark select option {
    background: #1a1a1a;
    color: #e2e8f0;
}

/* Better placeholder colors in dark mode */
html.dark input::placeholder {
    color: #64748b;
}

/* Date input calendar icon color in dark mode */
html.dark input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    opacity: 0.6;
}

html.dark input[type="date"]:hover::-webkit-calendar-picker-indicator {
    opacity: 1;
}

/* Better hover states for dark mode buttons */
html.dark button:hover {
    backdrop-filter: blur(10px);
}

/* Improve glass effect in dark mode */
html.dark .glass {
    background: rgba(255, 255, 255, 0.02);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
}

/* Better card shadows in dark mode */
html.dark .card-shadow {
    box-shadow: 0 4px 40px -10px rgba(0, 0, 0, 0.7), 
                0 0 0 1px rgba(255, 255, 255, 0.05);
}

html.dark .card-shadow:hover {
    box-shadow: 0 20px 60px -15px rgba(99, 102, 241, 0.3), 
                0 0 0 1px rgba(99, 102, 241, 0.2);
}
/* Faculty Hub Styles */
.faculty-card {
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    cursor: pointer;
}

.faculty-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px -15px rgba(168, 85, 247, 0.3);
}

.faculty-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.carousel-container {
    position: relative;
    max-width: 800px;
    width: 100%;
}

.screenshot-img {
    max-height: 70vh;
    width: auto;
    margin: 0 auto;
    border-radius: 1rem;
    box-shadow: 0 20px 60px -15px rgba(0, 0, 0, 0.5);
}
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 18px;
}
        .nav-btn {
            position: relative;
            overflow: hidden;
        }

        .nav-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .nav-btn:hover::after {
            opacity: 1;
        }

        .gradient-text {
            background: linear-gradient(135deg, #6366f1, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card-shadow {
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.1), 
                        0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .dark .card-shadow {
            box-shadow: 0 4px 40px -10px rgba(0, 0, 0, 0.5), 
                        0 0 0 1px rgba(255, 255, 255, 0.03);
        }

        .card-shadow:hover {
            box-shadow: 0 20px 40px -15px rgba(99, 102, 241, 0.25), 
                        0 0 0 1px rgba(99, 102, 241, 0.1);
        }
        /* Skeleton Loading Animations */
.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
}

.dark .skeleton {
    background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
    background-size: 200% 100%;
}

@keyframes skeleton-loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

.skeleton-text {
    height: 1em;
    margin-bottom: 0.5em;
    border-radius: 4px;
}

.skeleton-title {
    height: 2em;
    width: 60%;
    margin-bottom: 1em;
    border-radius: 8px;
}

.skeleton-card {
    border-radius: 1.5rem;
    overflow: hidden;
}

.skeleton-circle {
    border-radius: 50%;
}

.skeleton-chart {
    height: 400px;
    border-radius: 1.5rem;
}
/* DataTables Custom Styling */
.dataTables_wrapper {
    padding: 1.5rem;
}

.dataTables_filter {
    float: right;
    margin-bottom: 1rem;
}

.dataTables_filter input {
    padding: 0.5rem 1rem;
    border-radius: 0.75rem;
    border: 1px solid #e2e8f0;
    margin-left: 0.5rem;
    font-size: 0.875rem;
    outline: none;
    transition: all 0.2s;
}

html.dark .dataTables_filter input {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: #e2e8f0;
}

.dataTables_filter input:focus {
    border-color: #a855f7;
    box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
}

.dataTables_length select {
    padding: 0.5rem 2rem 0.5rem 1rem;
    border-radius: 0.75rem;
    border: 1px solid #e2e8f0;
    margin: 0 0.5rem;
    font-size: 0.875rem;
    outline: none;
}

html.dark .dataTables_length select {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: #e2e8f0;
}

.dataTables_info {
    padding-top: 1rem;
    font-size: 0.875rem;
    color: #64748b;
}

html.dark .dataTables_info {
    color: #94a3b8;
}

.dataTables_paginate {
    padding-top: 1rem;
    float: right;
}

.dataTables_paginate .paginate_button {
    padding: 0.5rem 1rem;
    margin: 0 0.25rem;
    border-radius: 0.5rem;
    border: 1px solid #e2e8f0;
    background: white;
    color: #475569;
    cursor: pointer;
    transition: all 0.2s;
}

html.dark .dataTables_paginate .paginate_button {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: #cbd5e1;
}

.dataTables_paginate .paginate_button:hover {
    background: #a855f7;
    border-color: #a855f7;
    color: white;
}

.dataTables_paginate .paginate_button.current {
    background: #a855f7;
    border-color: #a855f7;
    color: white;
}

.dataTables_paginate .paginate_button.disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

table.dataTable thead th {
    position: relative;
}

table.dataTable thead th select {
    display: block;
}
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: 'rgba(255, 255, 255, 0.1)',
                        background: {
                            light: '#fafafa',
                            dark: '#030303'
                        }
                    },
                    borderRadius: {
                        '2xl': '1rem',
                        '3xl': '1.5rem',
                        '4xl': '2rem',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
</head>
<body class="bg-[#fafafa] text-slate-900 dark:bg-[#030303] dark:text-slate-100 min-h-screen antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-0 h-screen bg-white dark:bg-[#0a0a0a] border-r border-slate-200/80 dark:border-white/[0.08] transition-all duration-500 ease-out z-50 flex flex-col sidebar-expanded backdrop-blur-xl">
        
       <!-- Logo Section -->
<div class="flex items-center justify-between px-6 py-6 border-b border-slate-200/50 dark:border-white/[0.06]">

    <div id="sidebar-logo-container" class="flex items-center gap-3 overflow-hidden">

        <!-- PNG Logo -->
        <img src="dbmci-one-logo.png" alt="DBMCI One"
        class="w-100 h-20 object-contain">

        <!-- Logo Text -->
        <!-- <span class="text-xl font-extrabold tracking-tight 
        bg-gradient-to-r from-blue-600 via-cyan-500 to-blue-600 
        bg-clip-text text-transparent whitespace-nowrap">
            DBMCI One
        </span> -->

    </div>

</div>

        <!-- Navigation -->
        <nav class="flex flex-col gap-1.5 px-3 flex-1 py-6">
            <div class="text-[10px] font-extrabold text-slate-400 dark:text-slate-600 uppercase tracking-[0.15em] px-3 mb-2 sidebar-label">Navigation</div>
            
            <!-- Attendance Button -->
            <button id="nav-attendance" onclick="openAttendance()" class="nav-btn relative flex items-center gap-3 w-full px-4 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg shadow-blue-500/30 transition-all duration-300 hover:shadow-xl hover:shadow-blue-500/40 hover:scale-[1.02] group">
                <div class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/10 to-white/0 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                <i data-lucide="layout-dashboard" class="w-5 h-5 relative z-10"></i>
                <span class="sidebar-label font-bold text-sm relative z-10">Attendance</span>
            </button>
            
            <!-- Issues Button -->
            <button id="nav-issues" onclick="openIssues()" type="button" class="nav-btn relative flex items-center gap-3 w-full px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-white/[0.05] transition-all duration-300 group">
                <i data-lucide="alert-circle" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="sidebar-label font-bold text-sm"> Issues</span>
            </button>

            <!-- Faculty Hub Button -->
<button id="nav-faculty" onclick="openFacultyHub()" class="nav-btn relative flex items-center gap-3 w-full px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-white/[0.05] transition-all duration-300 group">
    <i data-lucide="users" class="w-5 h-5 transition-transform group-hover:scale-110"></i>
    <span class="sidebar-label font-bold text-sm">Faculty Hub</span>
</button>

            <!-- Bottom Actions -->
<div class="mt-auto space-y-2 pt-6 border-t border-slate-200/50 dark:border-white/[0.06]">

                <!-- Theme Toggle -->
<button onclick="toggleTheme()" class="flex items-center gap-3 w-full px-4 py-3 rounded-xl border border-slate-200/80 dark:border-white/[0.08] hover:border-blue-500/50 dark:hover:border-blue-500/50 hover:bg-blue-50 dark:hover:bg-blue-500/10 transition-all duration-300 group">
    <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-blue-100 to-cyan-100 dark:from-blue-900/30 dark:to-cyan-900/30 flex items-center justify-center group-hover:scale-110 transition-transform">
        <i id="theme-icon" data-lucide="sun" class="w-4 h-4 text-blue-600 dark:text-blue-400"></i>
    </div>
    <span id="theme-text" class="sidebar-label font-bold text-sm text-slate-700 dark:text-slate-300">Light Mode</span>
</button>
<!-- Admin Button -->
<button id="nav-admin" onclick="toggleAdminLogin()" class="flex items-center gap-3 w-full px-4 py-3 rounded-xl border border-slate-200/80 dark:border-white/[0.08] hover:border-amber-500/50 dark:hover:border-amber-500/50 hover:bg-amber-50 dark:hover:bg-amber-500/10 transition-all duration-300 group">
    <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-amber-100 to-orange-100 dark:from-amber-900/30 dark:to-orange-900/30 flex items-center justify-center group-hover:scale-110 transition-transform">
        <i data-lucide="shield-check" class="w-4 h-4 text-amber-600 dark:text-amber-400"></i>
    </div>
    <span class="sidebar-label font-bold text-sm text-slate-700 dark:text-slate-300">Admin</span>
</button>

<!-- Super Admin Switch (Only visible when logged in as admin) -->
<button id="super-admin-switch" onclick="toggleSuperAdmin()" class="hidden flex items-center gap-3 w-full px-4 py-3 rounded-xl border border-orange-200/80 dark:border-orange-500/[0.2] hover:border-orange-500/50 dark:hover:border-orange-500/50 hover:bg-orange-50 dark:hover:bg-orange-500/10 transition-all duration-300 group">
    <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-orange-100 to-red-100 dark:from-orange-900/30 dark:to-red-900/30 flex items-center justify-center group-hover:scale-110 transition-transform">
        <i data-lucide="shield-alert" class="w-4 h-4 text-orange-600 dark:text-orange-400"></i>
    </div>
    <span class="sidebar-label font-bold text-sm text-slate-700 dark:text-slate-300">Super Admin</span>
</button>
                <!-- Collapse Button -->
<button onclick="toggleSidebar()" 
class="flex items-center gap-3 w-full px-4 py-3 rounded-xl border border-slate-200/80 dark:border-white/[0.08]hover:border-blue-500/50 dark:hover:border-blue-500/50 text-slate-500 dark:text-slate-500 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-slate-100 dark:hover:bg-white/[0.05] transition-all duration-300 group">

                    <div class="w-9 h-9 rounded-lg bg-slate-100 dark:bg-white/[0.05] flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i id="toggle-icon" data-lucide="chevron-left" class="w-4 h-4 group-hover:-translate-x-0.5 transition-transform"></i>
                    </div>
                    <span class="sidebar-label font-bold text-sm text-slate-700 dark:text-slate-300">Collapse</span>
                </button>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="ml-[280px] p-8 lg:p-12 transition-all duration-500">
        <div id="attendance-ui">
        <div class="max-w-7xl mx-auto">
            
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-14 animate-fade-in-up">
                <div>
                    <span class="inline-flex items-center gap-2 text-indigo-600 dark:text-indigo-400 font-bold text-xs uppercase tracking-widest mb-3">
                        <span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
                        System Analytics
                    </span>
                    <h1 class="text-4xl lg:text-5xl xl:text-6xl font-extrabold tracking-tight">
                        Attendance <span class="text-slate-300 dark:text-slate-700">Pulse.</span>
                    </h1>
                </div>
                
                <div class="flex items-center gap-2 bg-white/80 dark:bg-white/5 p-1.5 rounded-2xl border border-slate-200 dark:border-white/10 shadow-lg backdrop-blur-xl">
                    <button id="btn-neet" onclick="setCourse('NEET PG')" class="course-btn px-5 py-2.5 rounded-xl text-sm font-bold transition-all bg-gradient-to-r from-indigo-600 to-violet-600 text-white shadow-lg shadow-indigo-500/25">NEET PG</button>
                    <button id="btn-fmge" onclick="setCourse('FMGE')" class="course-btn px-5 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-500 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-white/10">FMGE</button>
                    <button id="btn-atp" onclick="setCourse('ATP')" class="course-btn px-5 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-500 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-white/10">ATP</button>
                    <button id="btn-oneshot" onclick="setCourse('OneShot')" class="course-btn px-5 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-500 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-white/10">OneShot</button>
                    <button id="btn-td" disabled class="course-btn px-5 py-2.5 rounded-xl text-sm font-bold text-slate-400 opacity-40 cursor-not-allowed">T&D</button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-12">
                
                <div class="lg:col-span-3 glass p-8 rounded-3xl border border-slate-200/50 dark:border-white/5 card-shadow relative overflow-hidden shine-effect animate-fade-in-up" style="animation-delay: 0.1s;">
                    
                    <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-indigo-500/10 to-violet-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center gap-4 mb-8">
                            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-violet-500/20 flex items-center justify-center border border-indigo-500/20">
                                <i data-lucide="sliders-horizontal" class="w-7 h-7 text-indigo-500"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">Filters</h3>
                                <!-- <p class="text-sm text-slate-500 dark:text-slate-400">Refine data streams in real-</p> -->
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="space-y-2">
                                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-widest ml-1">Subject</label>
                                <select id="subject-filter" onchange="applyFilters()" class="w-full bg-slate-100/80 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-2xl px-4 py-4 text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 transition-all cursor-pointer">
                                    <option value="All">All Subjects</option>
                                </select>
                            </div>
                            <!-- <div class="space-y-2">
                                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-widest ml-1">Period</label>
                                <select id="month-filter" onchange="applyFilters()" class="w-full bg-slate-100/80 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-2xl px-4 py-4 text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 transition-all cursor-pointer">
                                    <option value="All">All Time</option>
                                </select>
                            </div> -->
                            <div class="space-y-2">
                                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-widest ml-1">Cycle</label>
                                <select id="cycle-filter" onchange="applyFilters()" class="w-full bg-slate-100/80 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-2xl px-4 py-4 text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 transition-all cursor-pointer">
                                    <option value="All">All</option>
                                    <option>Cycle 1</option>
                                    <option>Cycle 2</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="reset-btn" onclick="resetFilters()" class="hidden w-full h-[58px] rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-transparent hover:bg-red-50 dark:hover:bg-red-500/10 hover:border-red-300 dark:hover:border-red-500/30 text-slate-600 dark:text-slate-400 hover:text-red-600 transition-all font-bold text-sm flex items-center justify-center gap-2 group">
                                    <i data-lucide="refresh-ccw" class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500"></i>
                                    Reset All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass p-8 rounded-3xl border border-slate-200/50 dark:border-white/5 flex flex-col justify-center items-center text-center card-shadow animate-fade-in-up" style="animation-delay: 0.2s;">
                    <div class="w-20 h-20 rounded-full bg-gradient-to-br from-indigo-500/10 to-violet-500/10 flex items-center justify-center mb-5 border-4 border-indigo-500/10 pulse-glow">
                        <i data-lucide="radar" class="w-10 h-10 text-indigo-500"></i>
                    </div>
                    <div class="text-3xl lg:text-4xl font-black tracking-tighter mb-2 gradient-text" id="retention-value">0%</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">RETENTION RATE</div>
                </div>
                
            </div>

            <div id="kpi-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
<!-- First Day vs Last Day Comparison - Clean Version -->
<div class="glass p-8 rounded-3xl border border-slate-200/50 dark:border-white/5 card-shadow mt-14 animate-fade-in-up" style="animation-delay: 0.6s;">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h3 class="text-2xl lg:text-3xl font-extrabold tracking-tight mb-2">
                Journey Analytics â€” <span class="gradient-text">First Day vs Last Day</span>
            </h3>
            <p class="text-sm text-slate-500 dark:text-slate-400">Student retention journey â€¢ Same subject â€¢ Same cycle</p>
        </div>
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2">
                <span class="w-4 h-4 rounded-lg bg-indigo-500 shadow-lg shadow-indigo-500/50"></span>
                <span class="text-sm font-bold text-slate-600 dark:text-slate-400">First Day</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-4 h-4 rounded-lg bg-pink-500 shadow-lg shadow-pink-500/50"></span>
                <span class="text-sm font-bold text-slate-600 dark:text-slate-400">Last Day</span>
            </div>
        </div>
    </div>
    <div style="height: 400px;">
        <canvas id="firstLastChart"></canvas>
    </div>
</div>
            <div class="glass p-8 rounded-3xl border border-slate-200/50 dark:border-white/5 card-shadow mt-14 animate-fade-in-up" style="animation-delay: 0.7s;">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h3 class="text-2xl lg:text-3xl font-extrabold tracking-tight mb-2">
                            Drop Trend â€” <span class="gradient-text">Subject Wise</span>
                        </h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Cycle-over-cycle comparison â€¢ Higher drop = Lower retention</p>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-lg bg-indigo-500 shadow-lg shadow-indigo-500/50"></span>
                            <span class="text-sm font-bold text-slate-600 dark:text-slate-400">Cycle 1</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-lg bg-pink-500 shadow-lg shadow-pink-500/50"></span>
                            <span class="text-sm font-bold text-slate-600 dark:text-slate-400">Cycle 2</span>
                        </div>
                    </div>
                </div>
                <div style="height: 400px;">
                    <canvas id="dropChart"></canvas>
                </div>
            </div>
                <div class="glass p-8 rounded-3xl border border-slate-200/50 dark:border-white/5 card-shadow mt-14 animate-fade-in-up" style="animation-delay: 0.8s;">
    <div class="flex items-center justify-between mb-8">
        <h3 class="text-2xl lg:text-3xl font-extrabold tracking-tight">
            Retention â€” <span class="gradient-text">Subject Comparison</span>
        </h3>
        <div class="flex items-center gap-5 px-6 py-3 rounded-2xl bg-white/60 dark:bg-white/5 border border-slate-200/80 dark:border-white/10">
            <div class="flex items-center gap-2.5">
                <span class="w-3 h-3 rounded-full bg-indigo-500 shadow-md"></span>
                <span class="text-sm font-bold text-slate-700 dark:text-slate-300">Cycle 1</span>
            </div>
            <div class="flex items-center gap-2.5">
                <span class="w-3 h-3 rounded-full bg-pink-500 shadow-md"></span>
                <span class="text-sm font-bold text-slate-700 dark:text-slate-300">Cycle 2</span>
            </div>
        </div>
    </div>
    <div style="height: 420px;">
        <canvas id="retentionChart"></canvas>
    </div>
</div>

            <div id="poll-chart-container" class="glass p-8 rounded-3xl border border-slate-200/50 dark:border-white/5 card-shadow mt-8 animate-fade-in-up" style="animation-delay: 0.8s; display: none;">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h3 class="text-2xl lg:text-3xl font-extrabold tracking-tight mb-2">
                            Poll Distribution â€” <span class="gradient-text">Subject Engagement</span>
                        </h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Total polls conducted per subject</p>
                    </div>
                    <div class="flex items-center gap-2 px-4 py-2 rounded-xl bg-gradient-to-r from-indigo-500/10 to-purple-500/10 border border-indigo-500/20">
                        <i data-lucide="bar-chart-3" class="w-4 h-4 text-indigo-500"></i>
                        <span class="text-sm font-bold text-indigo-600 dark:text-indigo-400" id="total-polls-text">0 Total Polls</span>
                    </div>
                </div>
                <div style="height: 400px;">
                    <canvas id="pollChart"></canvas>
                </div>
            </div>

        </div>
</div>
  <div id="issues-ui" style="display:none;">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-12 animate-fade-in-up">
            <div>
                <span class="inline-flex items-center gap-2 text-rose-600 dark:text-rose-400 font-bold text-xs uppercase tracking-widest mb-3">
                    <span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span>
                    Issue Tracking
                </span>
                <h1 class="text-4xl lg:text-5xl xl:text-6xl font-extrabold tracking-tight text-slate-900 dark:text-white">
                    ClassFlow <span class="text-slate-400 dark:text-slate-600">Monitor.</span>
                </h1>
            </div>
        </div>

            <div class="glass mb-10 p-8 rounded-3xl border border-slate-200/50 dark:border-white/10 card-shadow animate-fade-in-up" style="animation-delay: 0.1s;">
    <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-violet-500/20 flex items-center justify-center border border-indigo-500/20 float-animation">
            <i data-lucide="sliders-horizontal" class="w-6 h-6 text-indigo-500"></i>
        </div>
        <div>
            <h2 class="text-xl font-extrabold tracking-tight text-slate-900 dark:text-white"> Filters</h2>
            <!-- <p class="text-xs text-slate-500 dark:text-slate-400">Real-</p> -->
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
    <div class="group">
        <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block transition-colors group-hover:text-indigo-600 dark:group-hover:text-indigo-400">Course</label>
        <select id="filter-course" onchange="applyIssueFilters()" class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 transition-all cursor-pointer text-slate-900 dark:text-slate-100 hover:border-indigo-400 dark:hover:border-indigo-500 hover:shadow-lg">
            <option value="all">All Courses</option>
        </select>
    </div>

    <div class="group">
        <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block transition-colors group-hover:text-indigo-600 dark:group-hover:text-indigo-400">Cycle</label>
        <select id="filter-cycle" onchange="applyIssueFilters()" class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 transition-all cursor-pointer text-slate-900 dark:text-slate-100 hover:border-indigo-400 dark:hover:border-indigo-500 hover:shadow-lg">
            <option value="all">All Cycles</option>
        </select>
    </div>

    <div class="group">
        <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block transition-colors group-hover:text-indigo-600 dark:group-hover:text-indigo-400">Faculty</label>
        <select id="filter-faculty" onchange="applyIssueFilters()" class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 transition-all cursor-pointer text-slate-900 dark:text-slate-100 hover:border-indigo-400 dark:hover:border-indigo-500 hover:shadow-lg">
            <option value="all">All Faculty</option>
        </select>
    </div>

    <div class="group">
        <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block transition-colors group-hover:text-indigo-600 dark:group-hover:text-indigo-400">From Date</label>
        <input id="filter-from" type="date" onchange="applyIssueFilters()" class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 transition-all text-slate-900 dark:text-slate-100 hover:border-indigo-400 dark:hover:border-indigo-500 hover:shadow-lg" />
    </div>

    <div class="group">
        <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block transition-colors group-hover:text-indigo-600 dark:group-hover:text-indigo-400">To Date</label>
        <input id="filter-to" type="date" onchange="applyIssueFilters()" class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 transition-all text-slate-900 dark:text-slate-100 hover:border-indigo-400 dark:hover:border-indigo-500 hover:shadow-lg" />
    </div>
</div>

    <div class="flex gap-3 mt-6 flex-wrap">
        <button onclick="setQuickDays(1)" class="px-5 py-2.5 rounded-full border border-slate-200 dark:border-white/10 bg-white/50 dark:bg-white/5 text-xs font-bold text-slate-700 dark:text-slate-300 hover:bg-indigo-500/10 hover:border-indigo-500/50 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all hover:scale-105 hover:shadow-lg active:scale-95">
            Last 24h
        </button>

        <button onclick="setQuickDays(3)" class="px-5 py-2.5 rounded-full border border-slate-200 dark:border-white/10 bg-white/50 dark:bg-white/5 text-xs font-bold text-slate-700 dark:text-slate-300 hover:bg-indigo-500/10 hover:border-indigo-500/50 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all hover:scale-105 hover:shadow-lg active:scale-95">
            Last 3 days
        </button>

        <button onclick="setQuickDays(7)" class="px-5 py-2.5 rounded-full border border-slate-200 dark:border-white/10 bg-white/50 dark:bg-white/5 text-xs font-bold text-slate-700 dark:text-slate-300 hover:bg-indigo-500/10 hover:border-indigo-500/50 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all hover:scale-105 hover:shadow-lg active:scale-95">
            Last 7 days
        </button>

        <button onclick="setQuickDays(30)" class="px-5 py-2.5 rounded-full border border-slate-200 dark:border-white/10 bg-white/50 dark:bg-white/5 text-xs font-bold text-slate-700 dark:text-slate-300 hover:bg-indigo-500/10 hover:border-indigo-500/50 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all hover:scale-105 hover:shadow-lg active:scale-95">
            Last 30 days
        </button>

        <button id="filter-reset" onclick="resetIssueFilters()" class="px-5 py-2.5 rounded-full border border-red-300 dark:border-red-500/30 bg-red-50 dark:bg-red-500/10 text-xs font-bold text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-500/20 transition-all hover:scale-105 hover:shadow-lg active:scale-95 hidden">
            <i data-lucide="x" class="w-3 h-3 inline mr-1"></i>
            Reset All
        </button>
        
    </div>
</div>

        <div id="issue-table"></div>
    </div>
</div>
<div id="issue-table"></div>
    </div>
</div>

<!-- FACULTY HUB UI - NEW SECTION -->
<div id="faculty-ui" style="display:none;">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-12 animate-fade-in-up">
            <div>
                <span class="inline-flex items-center gap-2 text-purple-600 dark:text-purple-400 font-bold text-xs uppercase tracking-widest mb-3">
                    <span class="w-2 h-2 rounded-full bg-purple-500 animate-pulse"></span>
                    Student Appreciation
                </span>
                <h1 class="text-4xl lg:text-5xl xl:text-6xl font-extrabold tracking-tight text-slate-900 dark:text-white">
                    Appreciation <span class="text-slate-400 dark:text-slate-600">Wall.</span>
                </h1>
            </div>
        </div>

        <!-- Stats Bar -->
<div class="glass mb-10 p-6 rounded-3xl border border-slate-200/50 dark:border-white/10 card-shadow animate-fade-in-up">
    <div class="flex flex-wrap items-center justify-between gap-6 mb-6">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500/20 to-pink-500/20 flex items-center justify-center border border-purple-500/20">
                <i data-lucide="heart" class="w-6 h-6 text-purple-500"></i>
            </div>
            <div>
                <p class="text-2xl font-black text-slate-900 dark:text-white" id="total-appreciations">0</p>
                <p class="text-xs text-slate-500 dark:text-slate-400 font-semibold">Total Appreciations</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500/20 to-cyan-500/20 flex items-center justify-center border border-blue-500/20">
                <i data-lucide="users" class="w-6 h-6 text-blue-500"></i>
            </div>
            <div>
                <p class="text-2xl font-black text-slate-900 dark:text-white" id="total-faculty">21</p>
                <p class="text-xs text-slate-500 dark:text-slate-400 font-semibold">Faculty Members</p>
            </div>
        </div>

        <div class="flex-1 max-w-md">
            <input type="text" id="faculty-search" placeholder="ðŸ” Search faculty..." class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-purple-500/50 transition-all" oninput="filterFaculty()">
        </div>
    </div>

    <!-- NEW FILTERS -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 pt-6 border-t border-slate-200/50 dark:border-white/10">
        <div>
            <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block">Course</label>
            <select id="faculty-course-filter" onchange="filterFaculty()" class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-purple-500/50 transition-all cursor-pointer">
                <option value="all">All Courses</option>
                <option value="NEET PG">NEET PG</option>
                <option value="FMGE">FMGE</option>
                <option value="OneShot">OneShot</option>
            </select>
        </div>

        <div>
            <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block">Cycle</label>
            <select id="faculty-cycle-filter" onchange="filterFaculty()" class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-purple-500/50 transition-all cursor-pointer">
                <option value="all">All Cycles</option>
                <option value="Cycle 1">Cycle 1</option>
                <option value="Cycle 2">Cycle 2</option>
            </select>
        </div>

        <div>
            <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block">Day</label>
            <select id="faculty-day-filter" onchange="filterFaculty()" class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-purple-500/50 transition-all cursor-pointer">
                <option value="all">All Days</option>
                <option value="Day 1">Day 1</option>
                <option value="Day 2">Day 2</option>
                <option value="Day 3">Day 3</option>
                <option value="Day 4">Day 4</option>
                <option value="Day 5">Day 5</option>
                <option value="Day 6">Day 6</option>
                <option value="Day 7">Day 7</option>
                <option value="Day 8">Day 8</option>
                <option value="Day 9">Day 9</option>
                <option value="Day 10">Day 10</option>
                <option value="Day 11">Day 11</option>
                <option value="Day 12">Day 12</option>
                <option value="Day 13">Day 13</option>
                <option value="Day 14">Day 14</option>
                <option value="Day 15">Day 15</option>
            </select>
        </div>

        <div class="flex items-end">
            <button onclick="resetFacultyFilters()" class="w-full h-[58px] rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-transparent hover:bg-red-50 dark:hover:bg-red-500/10 hover:border-red-300 dark:hover:border-red-500/30 text-slate-600 dark:text-slate-400 hover:text-red-600 transition-all font-bold text-sm flex items-center justify-center gap-2 group">
                <i data-lucide="refresh-ccw" class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500"></i>
                Reset Filters
            </button>
        </div>
    </div>
</div>

        <!-- Admin Upload Panel -->
        <div id="admin-upload-panel" class="glass mb-10 p-8 rounded-3xl border border-slate-200/50 dark:border-white/10 card-shadow animate-fade-in-up hidden">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 flex items-center justify-center border border-amber-500/20">
                    <i data-lucide="upload" class="w-6 h-6 text-amber-500"></i>
                </div>
                <div>
                    <h2 class="text-xl font-extrabold tracking-tight text-slate-900 dark:text-white">Upload Student Messages</h2>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Add chat screenshots from live classes</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <div>
        <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block">Select Faculty <span class="text-red-500">*</span></label>
        <select id="admin-faculty-select" required class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-amber-500/50 transition-all">
            <option value="">Choose faculty...</option>
        </select>
    </div>
    <div>
        <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block">Course <span class="text-red-500">*</span></label>
        <select id="admin-course-select" required class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-amber-500/50 transition-all">
            <option value="">Select course...</option>
            <option>NEET PG</option>
            <option>FMGE</option>
            <option>OneShot</option>
        </select>
    </div>
    <div>
        <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block">Cycle <span class="text-red-500">*</span></label>
        <select id="admin-cycle-select" required class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-amber-500/50 transition-all">
            <option value="">Select cycle...</option>
            <option>Cycle 1</option>
            <option>Cycle 2</option>
        </select>
    </div>
    <div>
        <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block">Day <span class="text-red-500">*</span></label>
        <select id="admin-day-select" required class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-amber-500/50 transition-all">
            <option value="">Select day...</option>
            <option>Day 1</option>
            <option>Day 2</option>
            <option>Day 3</option>
            <option>Day 4</option>
            <option>Day 5</option>
            <option>Day 6</option>
            <option>Day 7</option>
            <option>Day 8</option>
            <option>Day 9</option>
            <option>Day 10</option>
            <option>Day 11</option>
            <option>Day 12</option>
            <option>Day 13</option>
            <option>Day 14</option>
            <option>Day 15</option>
        </select>
    </div>
</div>

            <div id="upload-preview" class="mb-6 hidden">
                <p class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-3">Preview:</p>
                <div id="preview-container" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
            <div class="mb-6">
    <label class="text-xs uppercase font-semibold text-slate-600 dark:text-slate-400 mb-2 block">Upload Screenshots <span class="text-red-500">*</span></label>
    <input type="file" 
           id="admin-image-upload" 
           multiple 
           accept="image/*,image/png,image/jpeg,image/jpg,image/gif,image/webp" 
           class="w-full rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-4 py-3 text-sm font-semibold outline-none focus:ring-2 focus:ring-amber-500/50 transition-all file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-amber-500 file:text-white hover:file:bg-amber-600 cursor-pointer">
</div>

            <button onclick="uploadImages()" class="px-6 py-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold text-sm shadow-lg hover:shadow-xl hover:scale-105 transition-all">
                <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>
                Upload Screenshots
            </button>
            
        </div>
        </div>

<!-- NEW: Admin Management Panel -->
<div id="admin-management-panel" class="glass mt-10 p-8 rounded-3xl border border-slate-200/50 dark:border-white/10 card-shadow animate-fade-in-up hidden">
    <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-red-500/20 to-orange-500/20 flex items-center justify-center border border-red-500/20">
            <i data-lucide="settings" class="w-6 h-6 text-red-500"></i>
        </div>
        <div>
            <h2 class="text-xl font-extrabold tracking-tight text-slate-900 dark:text-white">Manage Data</h2>
            <p class="text-xs text-slate-500 dark:text-slate-400">Add or remove faculty, courses, cycles, and days</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Manage Faculty -->
        <div class="p-6 rounded-2xl border border-slate-200 dark:border-white/10 bg-white/50 dark:bg-white/5">
            <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <i data-lucide="users" class="w-4 h-4"></i>
                Manage Faculty
            </h3>
            <div class="space-y-3">
                <input type="text" id="new-faculty-name" placeholder="Faculty name (e.g., Dr. John Doe)" class="w-full rounded-xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/50">
                <button onclick="addFaculty()" class="w-full px-4 py-2 rounded-xl bg-blue-500 text-white text-sm font-bold hover:bg-blue-600 transition-all">
                    <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                    Add Faculty
                </button>
                <button onclick="showDeleteFacultyModal()" class="w-full px-4 py-2 rounded-xl border border-red-300 dark:border-red-500/30 text-red-600 dark:text-red-400 text-sm font-bold hover:bg-red-50 dark:hover:bg-red-500/10 transition-all">
                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                    Delete Faculty
                </button>
            </div>
        </div>

        <!-- Manage Course -->
        <div class="p-6 rounded-2xl border border-slate-200 dark:border-white/10 bg-white/50 dark:bg-white/5">
            <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <i data-lucide="book-open" class="w-4 h-4"></i>
                Manage Courses
            </h3>
            <div class="space-y-3">
                <input type="text" id="new-course-name" placeholder="Course name (e.g., ATP)" class="w-full rounded-xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-green-500/50">
                <button onclick="addCourse()" class="w-full px-4 py-2 rounded-xl bg-green-500 text-white text-sm font-bold hover:bg-green-600 transition-all">
                    <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                    Add Course
                </button>
                <button onclick="showDeleteCourseModal()" class="w-full px-4 py-2 rounded-xl border border-red-300 dark:border-red-500/30 text-red-600 dark:text-red-400 text-sm font-bold hover:bg-red-50 dark:hover:bg-red-500/10 transition-all">
                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                    Delete Course
                </button>
            </div>
        </div>

        <!-- Manage Cycle -->
        <div class="p-6 rounded-2xl border border-slate-200 dark:border-white/10 bg-white/50 dark:bg-white/5">
            <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <i data-lucide="repeat" class="w-4 h-4"></i>
                Manage Cycles
            </h3>
            <div class="space-y-3">
                <input type="text" id="new-cycle-name" placeholder="Cycle name (e.g., Cycle 3)" class="w-full rounded-xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-purple-500/50">
                <button onclick="addCycle()" class="w-full px-4 py-2 rounded-xl bg-purple-500 text-white text-sm font-bold hover:bg-purple-600 transition-all">
                    <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                    Add Cycle
                </button>
                <button onclick="showDeleteCycleModal()" class="w-full px-4 py-2 rounded-xl border border-red-300 dark:border-red-500/30 text-red-600 dark:text-red-400 text-sm font-bold hover:bg-red-50 dark:hover:bg-red-500/10 transition-all">
                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                    Delete Cycle
                </button>
            </div>
        </div>

        <!-- Manage Day -->
        <div class="p-6 rounded-2xl border border-slate-200 dark:border-white/10 bg-white/50 dark:bg-white/5">
            <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <i data-lucide="calendar" class="w-4 h-4"></i>
                Manage Days
            </h3>
            <div class="space-y-3">
                <input type="number" id="new-day-number" placeholder="Day number (e.g., 16)" min="1" class="w-full rounded-xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-orange-500/50">
                <button onclick="addDay()" class="w-full px-4 py-2 rounded-xl bg-orange-500 text-white text-sm font-bold hover:bg-orange-600 transition-all">
                    <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                    Add Day
                </button>
                <button onclick="showDeleteDayModal()" class="w-full px-4 py-2 rounded-xl border border-red-300 dark:border-red-500/30 text-red-600 dark:text-red-400 text-sm font-bold hover:bg-red-50 dark:hover:bg-red-500/10 transition-all">
                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                    Delete Day
                </button>
            </div>
        </div>
    </div>
</div>

        <!-- Faculty Grid -->
        <div id="faculty-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
    </div>
</div>

<!-- Faculty Modal -->
<div id="faculty-modal" class="faculty-modal hidden" onclick="closeFacultyModal(event)">
    <div class="carousel-container glass rounded-3xl border border-slate-200/50 dark:border-white/10 p-8 max-w-4xl w-full" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-full overflow-hidden border-4 border-purple-500/30">
                    <img id="modal-faculty-avatar" src="" alt="" class="w-full h-full object-cover">
                </div>
                <div>
                    <h2 id="modal-faculty-name" class="text-2xl font-extrabold text-slate-900 dark:text-white"></h2>
                    <p id="modal-faculty-count" class="text-sm text-slate-500 dark:text-slate-400 font-semibold"></p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- Bulk Delete Mode Toggle (Admin Only) -->
                <button id="bulk-delete-toggle" onclick="toggleBulkDeleteMode()" class="hidden px-4 py-2 rounded-xl border border-purple-300 dark:border-purple-500/30 text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-500/10 transition-all text-sm font-semibold">
                    <i data-lucide="check-square" class="w-4 h-4 inline mr-1"></i>
                    Select Multiple
                </button>
                
                <button onclick="closeFacultyModal()" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-white/5 hover:bg-red-500 hover:text-white transition-all flex items-center justify-center">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Bulk Delete Controls (Hidden by default) -->
        <div id="bulk-delete-controls" class="hidden mb-6 p-4 rounded-2xl bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-500/30">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()" class="w-5 h-5 rounded border-2 border-purple-400 text-purple-600 focus:ring-purple-500 cursor-pointer">
                        <span class="text-sm font-bold text-slate-900 dark:text-white">Select All</span>
                    </label>
                    <span id="selected-count" class="text-sm font-semibold text-purple-600 dark:text-purple-400">0 selected</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="cancelBulkDelete()" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-white/10 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 transition-all text-sm font-semibold">
                        Cancel
                    </button>
                    <button onclick="confirmBulkDelete()" class="px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600 transition-all text-sm font-semibold disabled:opacity-50 disabled:cursor-not-allowed" id="bulk-delete-btn" disabled>
                        <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                        Delete Selected
                    </button>
                </div>
            </div>
        </div>

        <div class="relative mb-6" id="screenshot-view-container">
            <!-- Single Image View (Default) -->
            <div id="single-view" class="relative">
                <button onclick="prevScreenshot()" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 w-12 h-12 rounded-full bg-white dark:bg-slate-800 shadow-xl flex items-center justify-center hover:scale-110 transition-all z-10">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                
                <div id="screenshot-container" class="flex items-center justify-center bg-slate-100 dark:bg-slate-900 rounded-2xl p-8 min-h-[400px]">
                    <img id="current-screenshot" src="" alt="" class="screenshot-img">
                </div>

                <button onclick="nextScreenshot()" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 w-12 h-12 rounded-full bg-white dark:bg-slate-800 shadow-xl flex items-center justify-center hover:scale-110 transition-all z-10">
                    <i data-lucide="chevron-right" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Grid View (Bulk Delete Mode) -->
            <div id="grid-view" class="hidden">
                <div id="screenshot-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[500px] overflow-y-auto p-4">
                    <!-- Screenshots will be populated here -->
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between">
            <div class="flex gap-2" id="carousel-dots"></div>
            <div class="flex gap-2">
                <button onclick="downloadScreenshot()" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-white/10 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5 transition-all text-sm font-semibold">
                    <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
                    Download
                </button>
                <button onclick="deleteCurrentScreenshot()" class="px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600 transition-all text-sm font-semibold hidden" id="delete-screenshot-btn">
                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Super Admin Panel -->
<div id="super-admin-panel" class="glass mt-10 p-8 rounded-3xl border border-slate-200/50 dark:border-white/10 card-shadow animate-fade-in-up hidden">
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-orange-500/20 to-red-500/20 flex items-center justify-center border border-orange-500/20">
                <i data-lucide="shield-alert" class="w-6 h-6 text-orange-500"></i>
            </div>
            <div>
                <h2 class="text-xl font-extrabold tracking-tight text-slate-900 dark:text-white">Super Admin Control Panel</h2>
                <p class="text-xs text-slate-500 dark:text-slate-400">Manage admins and view activity logs</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Manage Admins -->
        <div class="p-6 rounded-2xl border border-slate-200 dark:border-white/10 bg-white/50 dark:bg-white/5">
            <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <i data-lucide="user-cog" class="w-4 h-4"></i>
                Manage Admin Credentials
            </h3>
            <div class="space-y-3">
                <input type="email" id="new-admin-email" placeholder="Email address" class="w-full rounded-xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-orange-500/50">
                <input type="password" id="new-admin-password" placeholder="Password" class="w-full rounded-xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-orange-500/50">
                <button onclick="addAdminCredential()" class="w-full px-4 py-2 rounded-xl bg-orange-500 text-white text-sm font-bold hover:bg-orange-600 transition-all">
                    <i data-lucide="user-plus" class="w-4 h-4 inline mr-1"></i>
                    Add Admin
                </button>
                <button onclick="showDeleteAdminModal()" class="w-full px-4 py-2 rounded-xl border border-red-300 dark:border-red-500/30 text-red-600 dark:text-red-400 text-sm font-bold hover:bg-red-50 dark:hover:bg-red-500/10 transition-all">
                    <i data-lucide="user-minus" class="w-4 h-4 inline mr-1"></i>
                    Remove Admin
                </button>
            </div>
        </div>

        <!-- Activity Logs -->
        <div class="p-6 rounded-2xl border border-slate-200 dark:border-white/10 bg-white/50 dark:bg-white/5">
            <h3 class="text-sm font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <i data-lucide="activity" class="w-4 h-4"></i>
                Activity Logs
            </h3>
            <button onclick="viewActivityLogs()" class="w-full px-4 py-2 rounded-xl bg-blue-500 text-white text-sm font-bold hover:bg-blue-600 transition-all">
                <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>
                View Full Activity Log
            </button>
        </div>
    </div>
</div>

<!-- Activity Logs Modal -->
<div id="activity-logs-modal" class="hidden fixed inset-0 z-[999] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-slate-200 dark:border-white/10 w-full max-w-5xl max-h-[80vh] overflow-hidden shadow-2xl">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-black dark:text-white">Activity Logs</h2>
                <p class="text-slate-500 dark:text-slate-400 text-sm">Last 100 actions</p>
            </div>
            <button onclick="closeActivityLogs()" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-white/5 hover:bg-red-500 hover:text-white transition-all flex items-center justify-center">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div id="logs-container" class="overflow-y-auto max-h-[60vh]">
            <!-- Logs will be populated here -->
        </div>
    </div>
</div>

<!-- Delete Admin Modal -->
<div id="delete-admin-modal" class="hidden fixed inset-0 z-[999] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-slate-200 dark:border-white/10 w-full max-w-md shadow-2xl">
        <h2 class="text-2xl font-black mb-4 dark:text-white">Remove Admin</h2>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Select admin to remove:</p>
        <select id="delete-admin-select" class="w-full p-4 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-white/10 dark:text-white mb-6">
            <option value="">Choose admin...</option>
        </select>
        <div class="flex gap-3">
            <button onclick="closeDeleteAdminModal()" class="flex-1 p-4 rounded-xl bg-slate-100 dark:bg-white/5 font-bold">Cancel</button>
            <button onclick="confirmDeleteAdmin()" class="flex-1 p-4 rounded-xl bg-red-600 text-white font-bold">Remove</button>
        </div>
    </div>
</div>
<!-- Admin Login Modal -->
<div id="admin-login-modal" class="hidden fixed inset-0 z-[999] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-slate-200 dark:border-white/10 w-full max-w-md shadow-2xl">
        <h2 class="text-2xl font-black mb-2 dark:text-white">Admin</h2>
        <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm">Please enter your credentials to manage faculty data.</p>
        
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Email Address</label>
                <input type="email" id="admin-email" placeholder="admin@example.com" class="w-full p-4 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-white/10 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all">
            </div>
            <div>
                <label class="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Password</label>
                <input type="password" id="admin-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full p-4 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-white/10 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all">
            </div>
            
            <p id="login-error" class="hidden text-red-500 text-sm font-bold bg-red-50 dark:bg-red-900/20 p-3 rounded-lg text-center">Invalid email or password</p>
            
            <div class="flex gap-3 mt-8">
                <button onclick="closeAdminLogin()" class="flex-1 p-4 rounded-xl bg-slate-100 dark:bg-white/5 font-bold text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-white/10 transition-all">Cancel</button>
                <button onclick="adminLogin()" class="flex-1 p-4 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg shadow-blue-600/30 transition-all">Login</button>
            </div>
        </div>
    </div>
</div>
</div>
<!-- Delete Faculty Modal -->
<div id="delete-faculty-modal" class="hidden fixed inset-0 z-[999] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-slate-200 dark:border-white/10 w-full max-w-md shadow-2xl">
        <h2 class="text-2xl font-black mb-4 dark:text-white">Delete Faculty</h2>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Select faculty to delete (this will delete all their screenshots):</p>
        <select id="delete-faculty-select" class="w-full p-4 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-white/10 dark:text-white mb-6">
            <option value="">Choose faculty...</option>
        </select>
        <div class="flex gap-3">
            <button onclick="closeDeleteFacultyModal()" class="flex-1 p-4 rounded-xl bg-slate-100 dark:bg-white/5 font-bold">Cancel</button>
            <button onclick="confirmDeleteFaculty()" class="flex-1 p-4 rounded-xl bg-red-600 text-white font-bold">Delete</button>
        </div>
    </div>
</div>

<!-- Delete Course Modal -->
<div id="delete-course-modal" class="hidden fixed inset-0 z-[999] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-slate-200 dark:border-white/10 w-full max-w-md shadow-2xl">
        <h2 class="text-2xl font-black mb-4 dark:text-white">Delete Course</h2>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Select course to delete:</p>
        <select id="delete-course-select" class="w-full p-4 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-white/10 dark:text-white mb-6">
            <option value="">Choose course...</option>
        </select>
        <div class="flex gap-3">
            <button onclick="closeDeleteCourseModal()" class="flex-1 p-4 rounded-xl bg-slate-100 dark:bg-white/5 font-bold">Cancel</button>
            <button onclick="confirmDeleteCourse()" class="flex-1 p-4 rounded-xl bg-red-600 text-white font-bold">Delete</button>
        </div>
    </div>
</div>

<!-- Delete Cycle Modal -->
<div id="delete-cycle-modal" class="hidden fixed inset-0 z-[999] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-slate-200 dark:border-white/10 w-full max-w-md shadow-2xl">
        <h2 class="text-2xl font-black mb-4 dark:text-white">Delete Cycle</h2>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Select cycle to delete:</p>
        <select id="delete-cycle-select" class="w-full p-4 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-white/10 dark:text-white mb-6">
            <option value="">Choose cycle...</option>
        </select>
        <div class="flex gap-3">
            <button onclick="closeDeleteCycleModal()" class="flex-1 p-4 rounded-xl bg-slate-100 dark:bg-white/5 font-bold">Cancel</button>
            <button onclick="confirmDeleteCycle()" class="flex-1 p-4 rounded-xl bg-red-600 text-white font-bold">Delete</button>
        </div>
    </div>
</div>

<!-- Delete Day Modal -->
<div id="delete-day-modal" class="hidden fixed inset-0 z-[999] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border border-slate-200 dark:border-white/10 w-full max-w-md shadow-2xl">
        <h2 class="text-2xl font-black mb-4 dark:text-white">Delete Day</h2>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Select day to delete:</p>
        <select id="delete-day-select" class="w-full p-4 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-white/10 dark:text-white mb-6">
            <option value="">Choose day...</option>
        </select>
        <div class="flex gap-3">
            <button onclick="closeDeleteDayModal()" class="flex-1 p-4 rounded-xl bg-slate-100 dark:bg-white/5 font-bold">Cancel</button>
            <button onclick="confirmDeleteDay()" class="flex-1 p-4 rounded-xl bg-red-600 text-white font-bold">Delete</button>
        </div>
    </div>
</div>
    </main>
    
    <script>
        

        function loadIssuesDashboard(){
            
    document.getElementById("issue-table").innerHTML =
        "<p style='font-size:20px'>Issues loaded</p>";
}

        let state = {
    course: 'NEET PG',
    subject: 'All',
    month: 'All',
    cycle: 'All',
    isDark: false,
    isCollapsed: false,
    isAdmin: false,
    selectedFaculty: null
};

        const metrics = [
            { id: 'total', label: 'Total Sessions', icon: 'monitor', gradient: 'from-blue-600 via-cyan-500 to-teal-400', val: '0' },
            { id: 'peak', label: 'Peak Engagement', icon: 'flame', gradient: 'from-orange-500 via-rose-500 to-pink-500', val: '0' },
            { id: 'low', label: 'Drop-off Rate', icon: 'trending-down', gradient: 'from-emerald-500 via-teal-400 to-cyan-400', val: '0%' },
            { id: 'polls', label: 'Active Polls', icon: 'pie-chart', gradient: 'from-violet-600 via-purple-500 to-fuchsia-400', val: '0' }
        ];

let activePage = "attendance";



// Faculty Hub Data
const facultyData = [
{ id: "dr-abdul-naseer", name: "Dr. Abdul Naseer", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Abdul" },
    { id: "dr-abhirami", name: "Dr. Abhirami", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Ajay" },
    { id: "dr-aditya-gupta", name: "Dr. Aditya Gupta", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Aditya" },
    { id: "dr-ajay-yadav", name: "Dr. Ajay Yadav", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Thameem" },
    { id: "dr-aman-setia", name: "Dr. Aman Setia", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Aman" },
    { id: "dr-amit-jain", name: "Dr. Amit Jain", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Amit" },
    { id: "dr-ashish-kumar", name: "Dr. Ashish Kumar", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Ashish" },
    { id: "dr-ashwani-kumar", name: "Dr. Ashwani Kumar", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Ashwani" },
    { id: "dr-jai-arora", name: "Dr. Jai Arora", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Jai" },
    { id: "dr-niha-aggarwal", name: "Dr. Niha Aggarwal", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Ajay" },
    { id: "dr-praveen-gupta", name: "Dr. Praveen Kr Gupta", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Praveen" },
    { id: "dr-rajat-jain", name: "Dr. Rajat Jain", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Amit" },
    { id: "dr-rajeev-shetty", name: "Dr. Rajeev Shetty", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Rajeev" },
    { id: "dr-ramyasree", name: "Dr. Ramyasree", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Rajat" },
    { id: "dr-sanjay-aggarwal", name: "Dr. Sanjay Aggarwal", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Sanjay" },
    { id: "dr-saurabh-bhatia", name: "Dr. Saurabh Bhatia", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=SaurabhB" },
    { id: "dr-saurabh-jindal", name: "Dr. Saurabh Jindal", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=SaurabhJ" },
    { id: "dr-sushil-vijay", name: "Dr. Sushil Vijay", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Sushil" },
    { id: "dr-thameem-saif", name: "Dr. Thameem Saif", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Thameem" },
    { id: "dr-vishwajeet-singh", name: "Dr. Vishwajeet Singh", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Aditya" },
    { id: "dr-vivekanandan", name: "Dr. Vivekanandan", avatar: "https://api.dicebear.com/7.x/notionists/svg?seed=Vivekanandan" }
];

let adminCredentials = JSON.parse(localStorage.getItem('adminCredentials')) || [
    { email: "vikas.singh@dbmci.one", password: "dbmci@2025" },
    { email: "lithisha.s@dbmci.one", password: "dbmci@2025" },
    { email: "karthik.n@dbmci.one", password: "dbmci@2025" },
    { email: "bhavna.singh@dbmi.edu.in", password: "dbmci@2025" },
    { email: "moderator@dbmci.one", password: "dbmci@2025" },
    { email: "admin@dbmci.one", password: "dbmci@2025" },
    { email: "daniel.paul@egurukulapp.com", password: "dbmci@2025" }
];

// Super admin list
const superAdmins = ['vikas.singh@dbmci.one', 'daniel.paul@egurukulapp.com'];

// Track current logged-in admin
let currentAdminEmail = '';
let isSuperAdmin = false;


        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuZjJioc2H2E45MTQ8gOh4M4kz7ixZxPa0OI2j5ep7uAPS5Mdfh52fa1nIb7qf0MCoW6gejn2Uj9PR/pub?gid=1875996986&single=true&output=csv";
        let sheetData = [];
        let dropChart = null;
        let pollChart = null;

        const SHEET_URLS = {
    attendance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuZjJioc2H2E45MTQ8gOh4M4kz7ixZxPa0OI2j5ep7uAPS5Mdfh52fa1nIb7qf0MCoW6gejn2Uj9PR/pub?gid=1875996986&single=true&output=csv",
    issues: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuZjJioc2H2E45MTQ8gOh4M4kz7ixZxPa0OI2j5ep7uAPS5Mdfh52fa1nIb7qf0MCoW6gejn2Uj9PR/pub?gid=287366765&single=true&output=csv"
};


        async function loadSheet(){
    try {
        const res = await fetch(SHEET_URLS[activePage]);
        const raw = await res.text();
        sheetData = csvToJson(raw);

        if(activePage === "attendance"){
            populateSubjects();
            applyFilters();
        }

        if(activePage === "issues"){
            loadIssuesDashboard();
        }

        lucide.createIcons();
    }
    catch(err){
        console.error(err);
        // Show error state
        if(activePage === "attendance"){
            document.getElementById('kpi-container').innerHTML = `
                <div class="col-span-4 text-center p-8 glass rounded-3xl border border-red-200 dark:border-red-500/20">
                    <i data-lucide="alert-circle" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
                    <p class="text-red-600 dark:text-red-400 font-bold">Failed to load data. Please refresh the page.</p>
                </div>
            `;
            lucide.createIcons();
        }
    }
}


        function csvToJson(csv) {
    const lines = csv.split('\n');
    const headers = lines[0].split(',').map(h => h.trim().replace(/['"]/g, ''));
    
    console.log("ðŸ“Š CSV Headers:", headers);
    
    const result = [];
    
    for(let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if(!line) continue;
        
        const obj = {};
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for(let char of line) {
            if(char === '"') {
                inQuotes = !inQuotes;
            } else if(char === ',' && !inQuotes) {
                values.push(current.trim().replace(/^["']|["']$/g, ''));
                current = '';
            } else {
                current += char;
            }
        }
        values.push(current.trim().replace(/^["']|["']$/g, ''));
        
        headers.forEach((header, index) => {
            obj[header] = values[index] || '';
        });
        
        // Only add rows that have actual data
        if(obj.Date && obj.Course) {
            result.push(obj);
        }
    }
    
    console.log("âœ… Parsed Rows:", result.length);
    console.log("ðŸ“ Sample Row:", result[0]);
    
    return result;
}

        function populateSubjects() {
            const subjects = [...new Set(sheetData.map(item => item.Subject))].filter(Boolean).sort();
            const select = document.getElementById('subject-filter');
            select.innerHTML = '<option value="All">All Subjects</option>';
            subjects.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.innerText = sub;
                select.appendChild(opt);
            });
        }

        function populateMonths() {
            const months = [...new Set(sheetData.map(item => {
                const dt = new Date(item.Date);
                if (dt.toString() === "Invalid Date") return null;
                return dt.toLocaleString("en", { month: "long" });
            }))].filter(Boolean).sort();
            
            const select = document.getElementById("month-filter");
            select.innerHTML = '<option value="All">All Time</option>';
            months.forEach(m => {
                const opt = document.createElement("option");
                opt.value = m;
                opt.innerText = m;
                select.appendChild(opt);
            });
        }

        function applyFilters() {
    state.subject = document.getElementById('subject-filter').value;
    state.cycle = document.getElementById('cycle-filter').value;

    const resetBtn = document.getElementById('reset-btn');
    if (state.subject !== 'All' || state.cycle !== 'All') {
        resetBtn.classList.remove('hidden');
        resetBtn.classList.add('flex');
    } else {
        resetBtn.classList.add('hidden');
        resetBtn.classList.remove('flex');
    }

    // Show skeleton while filtering
    showKPISkeleton();
    showChartSkeleton('dropChart');
    showChartSkeleton('retentionChart');
    showChartSkeleton('firstLastChart');  // â† ADD THIS LINE
    
    // Small delay to show skeleton effect
    setTimeout(() => {
        computeFiltered();
    }, 300);
}

        function resetFilters() {
            document.getElementById('subject-filter').value = 'All';
            document.getElementById('cycle-filter').value = 'All';
            applyFilters();
        }

        function computeFiltered() {
    const filtered = sheetData.filter(item => {
        const matchCourse = item.Course === state.course;
        const matchSubject = state.subject === "All" || item.Subject === state.subject;
        const matchCycle = state.cycle === "All" || item.Cycle === state.cycle;
        return matchCourse && matchSubject && matchCycle;
    });

    updateSheetMetrics(filtered);
    updateRetentionDisplay(filtered);
    buildDropTrend(filtered);
    buildRetention(filtered);
    buildFirstLastComparison(filtered);
    buildPollChart(filtered);
}

        function getPeakAttendance(data) {
    let best = 0;
    let bestSubject = "N/A";

    data.forEach(r => {
        ["Part A","Part B","Part C","Part D","Part E","Part F","Part G","Part H"].forEach(part => {
            let val = Number(r[part]);
            if(!isNaN(val) && val > best){
                best = val;
                bestSubject = r.Subject; 
                // No return here - just update the variables
            }
        });
    });

    return { best, bestSubject }; // âœ… Return after all loops complete
}
    function getDropOffRate(data) {
        let grouped = {};

        data.forEach(r => {
            if (!grouped[r.Date]) grouped[r.Date] = [];
            grouped[r.Date].push(r);
        });

        let percents = [];

        Object.values(grouped).forEach(rows => {
            let parts = [];
            ["Part A","Part B","Part C","Part D","Part E","Part F","Part G","Part H"].forEach(col => {
                rows.forEach(r=>{
                    if(r[col] && !isNaN(r[col])) parts.push(Number(r[col]));
                });
            });

            if(parts.length > 1){
                let drop = ((parts[0] - parts[parts.length - 1]) / parts[0]) * 100;
                percents.push(drop);
            }
        });

        if(percents.length === 0) return { percent: 0 };
        return { percent: (percents.reduce((a,b)=>a+b)/percents.length).toFixed(1) };
    }

    function getRetentionRate(data) {
        if (data.length === 0) return 0;

        let subjects = {};

        data.forEach(r => {
            let sub = r.Subject;
            let cycle = r.Cycle;
            let day = Number(r.Day.replace("Day-", ""));
            let partA = Number(r["Part A"]);

            if (!partA || isNaN(partA)) return;

            let key = sub + "_" + cycle;

            if (!subjects[key]) {
                subjects[key] = { first: [], last: [], maxDay: 0 };
            }

            subjects[key].maxDay = Math.max(subjects[key].maxDay, day);

            if (day === 1) subjects[key].first.push(partA);
        });

        for (let r of data) {
            let sub = r.Subject;
            let cycle = r.Cycle;
            let partA = Number(r["Part A"]);
            let day = Number(r.Day.replace("Day-", ""));
            let key = sub + "_" + cycle;

            if (subjects[key] && day === subjects[key].maxDay) {
                subjects[key].last.push(partA);
            }
        }

        let allFirst = [];
        let allLast = [];

        Object.values(subjects).forEach(s => {
            if (s.first.length && s.last.length) {
                allFirst.push(average(s.first));
                allLast.push(average(s.last));
            }
        });

        if (!allFirst.length || !allLast.length) return 0;

        let startAvg = average(allFirst);
        let endAvg   = average(allLast);

        return ((endAvg / startAvg) * 100).toFixed(1);
    }

    function average(arr){
        return arr.reduce((a,b)=>a+b,0)/arr.length;
    }

    function checkIfSinglePartClass(data) {
        let grouped = {};

        data.forEach(r => {
            if (!grouped[r.Date]) grouped[r.Date] = [];
            grouped[r.Date].push(r);
        });

        for (let dateKey in grouped) {
            let rows = grouped[dateKey];
            let partsWithValues = [];

            ["Part A","Part B","Part C","Part D","Part E","Part F","Part G","Part H"].forEach(col => {
                rows.forEach(r => {
                    let val = Number(r[col]);
                    if (!isNaN(val) && val > 0 && !partsWithValues.includes(col)) {
                        partsWithValues.push(col);
                    }
                });
            });

            if (partsWithValues.length > 1) {
                return false;
            }
        }

        return true;
    }

    function updateSheetMetrics(data) {
        metrics[0].val = data.length.toLocaleString();

        let peak = getPeakAttendance(data);
        metrics[1].val = peak.best > 0 ? `${peak.best.toLocaleString()} â€” ${peak.bestSubject}` : '0';

        const isOneShot = state.course === 'OneShot';
        const isSinglePart = isOneShot && checkIfSinglePartClass(data);
        
        if (isSinglePart) {
            metrics[2].val = "Single Part Class";
        } else {
            let drop = getDropOffRate(data);
            metrics[2].val = drop.percent + "%";
        }

        let totalPolls = data.reduce((sum, r) => {
            let x = Number(r["Total Polls"]);
            return sum + (isNaN(x) ? 0 : x);
        }, 0);
        metrics[3].val = totalPolls.toLocaleString();

        renderKPIs(isSinglePart);
    }

    function updateRetentionDisplay(data) {
        const isOneShot = state.course === 'OneShot';
        const isSinglePart = isOneShot && checkIfSinglePartClass(data);
        
        const retentionElement = document.getElementById("retention-value");
        
        if (isSinglePart) {
            retentionElement.innerText = "Single Part";
            retentionElement.style.fontSize = "1.25rem";
        } else if (isOneShot) {
            const drop = getDropOffRate(data);
            retentionElement.innerText = drop.percent + "%";
            retentionElement.style.fontSize = "";
        } else {
            const retention = getRetentionRate(data);
            retentionElement.innerText = retention + "%";
            retentionElement.style.fontSize = "";
        }
    }
    function loadIssuesDashboard(){
    
    // // Show skeleton while loading
    // document.getElementById("issue-table").innerHTML = showIssuesKPISkeleton() + showIssuesChartsSkeleton();
    // lucide.createIcons();
    
    // // Small delay to show skeleton (simulate loading)
    // setTimeout(() => {
        
        let html = `
        
        <!-- KPI ROW -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">

            <div class="glass p-6 rounded-3xl border border-slate-200/50 dark:border-white/10 text-center card-shadow relative overflow-hidden group hover:transform hover:scale-105 transition-all duration-300 animate-fade-in-up" style="animation-delay: 0s;">
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-500/10 to-cyan-500/10 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>
                <div class="relative z-10">
                    <div class="w-14 h-14 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-blue-500/20 to-cyan-500/20 flex items-center justify-center border border-blue-500/30 dark:border-blue-500/20">
                        <i data-lucide="alert-octagon" class="w-7 h-7 text-blue-500"></i>
                    </div>
                    <h2 class="text-3xl lg:text-4xl font-black tracking-tighter mb-2 gradient-text" id="kpi-total-issues">0</h2>
                    <p class="text-[11px] uppercase tracking-widest text-slate-500 dark:text-slate-400 font-bold">
                        Total Issues
                    </p>
                </div>
            </div>

            <div class="glass p-6 rounded-3xl border border-slate-200/50 dark:border-white/10 text-center card-shadow relative overflow-hidden group hover:transform hover:scale-105 transition-all duration-300 animate-fade-in-up" style="animation-delay: 0.1s;">
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-violet-500/10 to-purple-500/10 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>
                <div class="relative z-10">
                    <div class="w-14 h-14 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-violet-500/20 to-purple-500/20 flex items-center justify-center border border-violet-500/30 dark:border-violet-500/20">
                        <i data-lucide="layers" class="w-7 h-7 text-violet-500"></i>
                    </div>
                    <h2 class="text-lg lg:text-xl font-black tracking-tighter mb-2 text-slate-900 dark:text-white" id="kpi-top-category">-</h2>
                    <p class="text-[11px] uppercase tracking-widest text-slate-500 dark:text-slate-400 font-bold">
                        Top Category
                    </p>
                </div>
            </div>

            <div class="glass p-6 rounded-3xl border border-slate-200/50 dark:border-white/10 text-center card-shadow relative overflow-hidden group hover:transform hover:scale-105 transition-all duration-300 animate-fade-in-up" style="animation-delay: 0.2s;">
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-rose-500/10 to-pink-500/10 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>
                <div class="relative z-10">
                    <div class="w-14 h-14 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-rose-500/20 to-pink-500/20 flex items-center justify-center border border-rose-500/30 dark:border-rose-500/20">
                        <i data-lucide="user-x" class="w-7 h-7 text-rose-500"></i>
                    </div>
                    <h2 class="text-lg lg:text-xl font-black tracking-tighter mb-2 text-slate-900 dark:text-white" id="kpi-top-faculty">-</h2>
                    <p class="text-[11px] uppercase tracking-widest text-slate-500 dark:text-slate-400 font-bold">
                        Most Affected Faculty
                    </p>
                </div>
            </div>

            <div class="glass p-6 rounded-3xl border border-slate-200/50 dark:border-white/10 text-center card-shadow relative overflow-hidden group hover:transform hover:scale-105 transition-all duration-300 animate-fade-in-up" style="animation-delay: 0.3s;">
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-emerald-500/10 to-teal-500/10 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>
                <div class="relative z-10">
                    <div class="w-14 h-14 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-teal-500/20 flex items-center justify-center border border-emerald-500/30 dark:border-emerald-500/20">
                        <i data-lucide="map-pin" class="w-7 h-7 text-emerald-500"></i>
                    </div>
                    <h2 class="text-lg lg:text-xl font-black tracking-tighter mb-2 text-slate-900 dark:text-white" id="kpi-top-place">-</h2>
                    <p class="text-[11px] uppercase tracking-widest text-slate-500 dark:text-slate-400 font-bold">
                        Most Common Place
                    </p>
                </div>
            </div>

        </div>
        <!-- CATEGORY DISTRIBUTION - HORIZONTAL BARS -->
<div class="glass p-8 rounded-3xl border border-slate-200/50 dark:border-white/10 mb-10 card-shadow animate-fade-in-up relative overflow-hidden" style="animation-delay: 0.2s;">
    
    <!-- Decorative gradient orbs -->
    <div class="absolute -top-20 -right-20 w-80 h-80 bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-full blur-3xl"></div>
    <div class="absolute -bottom-20 -left-20 w-80 h-80 bg-gradient-to-br from-indigo-500/20 to-purple-500/20 rounded-full blur-3xl"></div>
    
    <div class="relative z-10">
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500/20 to-pink-500/20 flex items-center justify-center border border-purple-500/30 dark:border-purple-500/20 float-animation">
                    <i data-lucide="bar-chart-3" class="w-8 h-8 text-purple-500"></i>
                </div>
                <div>
                    <h3 class="text-2xl lg:text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white mb-1">
                        Category <span class="gradient-text">Impact Analysis</span>
                    </h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400">Top 10 issue categories</p>
                </div>
            </div>
            
            <div class="flex flex-col gap-2">
                <div class="flex items-center gap-2 px-4 py-2 rounded-xl bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/20">
                    <i data-lucide="alert-circle" class="w-4 h-4 text-purple-500"></i>
                    <span class="text-sm font-bold text-purple-600 dark:text-purple-400" id="total-issues-chart">0 Total</span>
                </div>
                <div class="flex items-center gap-3 text-xs font-bold">
                    <span class="flex items-center gap-1">
                    </span>
                    <span class="flex items-center gap-1">
                    </span>
                </div>
            </div>
        </div>
        
        <div style="height: 500px; position: relative;">
            <canvas id="issuesPieChart"></canvas>
        </div>
    </div>
</div>

        <!-- CHART ROW -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">

            <div class="glass p-8 rounded-3xl border border-slate-200/50 dark:border-white/10 card-shadow animate-fade-in-up" style="animation-delay: 0.3s;">
                <div class="flex items-center gap-4 mb-8">
                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-violet-500/20 flex items-center justify-center border border-indigo-500/30 dark:border-indigo-500/20">
                        <i data-lucide="users" class="w-7 h-7 text-indigo-500"></i>
                    </div>
                    <div>
                        <h3 class="text-xl lg:text-2xl font-extrabold tracking-tight text-slate-900 dark:text-white">
                            Faculty <span class="gradient-text">Impact</span>
                        </h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Top affected Faculty</p>
                    </div>
                </div>
                <div style="height: 400px; position: relative;">
                    <canvas id="issuesFacultyChart"></canvas>
                </div>
            </div>

            <div class="glass p-8 rounded-3xl border border-slate-200/50 dark:border-white/10 card-shadow animate-fade-in-up" style="animation-delay: 0.4s;">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-teal-500/20 flex items-center justify-center border border-emerald-500/30 dark:border-emerald-500/20">
                            <i data-lucide="trending-up" class="w-7 h-7 text-emerald-500"></i>
                        </div>
                        <div>
                            <h3 class="text-xl lg:text-2xl font-extrabold tracking-tight text-slate-900 dark:text-white">
                                Timeline <span class="gradient-text">Trend</span>
                            </h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Issue progression over time</p>
                        </div>
                    </div>
                    
                    <!-- Filter Buttons -->
                    <div class="flex items-center gap-2 bg-gray-100 dark:bg-white/5 p-1.5 rounded-xl">
                        <button
                            id="timeline-daily-btn"
                            onclick="setIssuesTimelineView('daily')"
                            class="px-4 py-2 rounded-lg font-medium transition-all duration-200 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 text-sm"
                        >
                            Daily
                        </button>
                        <button
                            id="timeline-weekly-btn"
                            onclick="setIssuesTimelineView('weekly')"
                            class="px-4 py-2 rounded-lg font-medium transition-all duration-200 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 text-sm"
                        >
                            Weekly
                        </button>
                        <button
                            id="timeline-monthly-btn"
                            onclick="setIssuesTimelineView('monthly')"
                            class="px-4 py-2 rounded-lg font-medium transition-all duration-200 bg-white dark:bg-gray-800 text-purple-600 dark:text-purple-400 shadow-md text-sm"
                        >
                            Monthly
                        </button>
                    </div>
                </div>
                <div style="height: 400px; position: relative;">
                    <canvas id="issuesMonthChart"></canvas>
                </div>
            </div>

        </div>

        <!-- RAW DATA TOGGLE - Sticky and Sexy -->
        <div class="mt-10 sticky top-4 z-10">
            <div class="flex justify-end mb-4">
                <button onclick="toggleRawIssues()" 
                class="px-5 py-2.5 rounded-xl border border-slate-200 dark:border-white/10 bg-white/90 dark:bg-gray-900/90 backdrop-blur-xl text-slate-600 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 hover:border-indigo-500/50 text-xs font-bold transition-all flex items-center gap-2 shadow-lg hover:shadow-xl hover:scale-105">
                    <i data-lucide="database" class="w-3.5 h-3.5"></i>
                    View Raw Data
                </button>
            </div>
        </div>

        <div id="rawIssuesContainer" class="hidden mt-2"></div>

        `;

        document.getElementById("issue-table").innerHTML = html;

        buildIssuesAnalytics();
        lucide.createIcons();
        
}



    function renderKPIs(isSinglePart = false) {
        const container = document.getElementById('kpi-container');
        
        container.innerHTML = metrics.map((m, index) => {
            const isDropOff = index === 2;
            const shouldApplyLightStyle = isDropOff && isSinglePart;
            const opacityClass = shouldApplyLightStyle ? 'opacity-50' : '';
            const delay = 0.3 + (index * 0.1);
            
            return `
            <div class="kpi-card group relative p-8 rounded-3xl bg-white/90 dark:bg-[#0a0a0a] border border-slate-200/80 dark:border-white/5 card-shadow overflow-hidden cursor-pointer animate-fade-in-up ${opacityClass}" style="animation-delay: ${delay}s;">
                
                <div class="glow-orb absolute -right-10 -top-10 w-40 h-40 bg-gradient-to-br ${m.gradient} opacity-[0.05] rounded-full blur-3xl"></div>
                
                <div class="relative z-10">
                    <div class="kpi-icon w-16 h-16 rounded-2xl flex items-center justify-center mb-6 bg-gradient-to-br ${m.gradient} shadow-lg text-white">
                        <i data-lucide="${m.icon}" class="w-8 h-8"></i>
                    </div>
                    
                    <div class="space-y-1">
                        <h4 class="text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-[0.15em]">${m.label}</h4>
                        <p class="text-3xl lg:text-4xl font-extrabold tracking-tighter text-slate-900 dark:text-white">${m.val}</p>
                    </div>
                </div>

                <div class="accent-line absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r ${m.gradient}"></div>
            </div>
            `;
        }).join('');
        
        lucide.createIcons();
    }

    function setCourse(name) {
        state.course = name;
        document.querySelectorAll('.course-btn').forEach(btn => {
            btn.classList.remove('bg-gradient-to-r', 'from-indigo-600', 'to-violet-600', 'text-white', 'shadow-lg', 'shadow-indigo-500/25');
            btn.classList.add('text-slate-500');
        });
        const activeBtn = Array.from(document.querySelectorAll('.course-btn')).find(b => b.innerText === name);
        if(activeBtn) {
            activeBtn.classList.add('bg-gradient-to-r', 'from-indigo-600', 'to-violet-600', 'text-white', 'shadow-lg', 'shadow-indigo-500/25');
            activeBtn.classList.remove('text-slate-500');
        }
        applyFilters();
    }

    function toggleSidebar() {
        state.isCollapsed = !state.isCollapsed;
        const sb = document.getElementById('sidebar');
        const main = document.getElementById('main-content');
        const toggle = document.getElementById('toggle-icon');
        
        if(state.isCollapsed) {
            sb.classList.replace('sidebar-expanded', 'sidebar-collapsed');
            main.classList.replace('ml-[280px]', 'ml-[80px]');
            toggle.setAttribute('data-lucide', 'chevron-right');
            document.querySelectorAll('.sidebar-label').forEach(l => l.style.display = 'none');
            document.getElementById('sidebar-text').style.display = 'none';
        } else {
            sb.classList.replace('sidebar-collapsed', 'sidebar-expanded');
            main.classList.replace('ml-[80px]', 'ml-[280px]');
            toggle.setAttribute('data-lucide', 'chevron-left');
            document.querySelectorAll('.sidebar-label').forEach(l => l.style.display = 'block');
            document.getElementById('sidebar-text').style.display = 'block';
        }
        lucide.createIcons();
    }

    function toggleTheme() {
    state.isDark = !state.isDark;
    document.documentElement.classList.toggle('dark');
    
    // Save preference to localStorage
    localStorage.setItem('theme', state.isDark ? 'dark' : 'light');
    
    const icon = document.getElementById('theme-icon');
    const text = document.getElementById('theme-text');
    icon.setAttribute('data-lucide', state.isDark ? 'moon' : 'sun');
    text.innerText = state.isDark ? 'Dark Mode' : 'Light Mode';
    lucide.createIcons();
    
    if (dropChart) {
        const filtered = sheetData.filter(item => {
            const matchCourse = item.Course === state.course;
            const matchSubject = state.subject === "All" || item.Subject === state.subject;
            let matchMonth = true;
            if (state.month !== "All") {
                const dt = new Date(item.Date);
                const month = dt.toLocaleString("en", { month: "long" });
                matchMonth = month === state.month;
            }
            const matchCycle = state.cycle === "All" || item.Cycle === state.cycle;
            return matchCourse && matchSubject && matchMonth && matchCycle;
        });
        buildDropTrend(filtered);
        buildRetention(filtered);
        buildPollChart(filtered);
    }
}

    function buildDropTrend(data) {
        let subjectGroups = {};

        data.forEach(r => {
            const sub = r.Subject;
            const cyc = r.Cycle;

            if (!subjectGroups[sub]) subjectGroups[sub] = { c1: [], c2: [] };

            let parts = [];
            ["Part A","Part B","Part C","Part D","Part E","Part F","Part G","Part H"]
            .forEach(col => {
                let v = Number(r[col]);
                if (!isNaN(v) && v > 0) parts.push(v);
            });

            if (parts.length > 1) {
                const drop = ((parts[0] - parts[parts.length - 1]) / parts[0]) * 100;

                if (cyc === "Cycle 1") subjectGroups[sub].c1.push(drop);
                if (cyc === "Cycle 2") subjectGroups[sub].c2.push(drop);
            }
        });

        let subjects = [];
        let c1vals = [];
        let c2vals = [];

        Object.entries(subjectGroups).forEach(([sub, v]) => {
            subjects.push(sub);
            c1vals.push(v.c1.length ? average(v.c1) : 0);
            c2vals.push(v.c2.length ? average(v.c2) : 0);
        });

        renderDropChart(subjects, c1vals, c2vals);
    }

    function renderDropChart(subjects, c1, c2) {
        if (dropChart) dropChart.destroy();

        const ctx = document.getElementById("dropChart");
        const isDark = document.documentElement.classList.contains('dark');

        dropChart = new Chart(ctx, {
            type: "line",
            plugins: [ChartDataLabels],
            data: {
                labels: subjects,
                datasets: [
                    {
                        label: "Cycle 1 Drop %",
                        data: c1,
                        tension: 0.4,
                        borderColor: "#6366f1",
                        backgroundColor: "rgba(99, 102, 241, 0.1)",
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: "#6366f1",
                        pointBorderColor: "#fff",
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: "#6366f1",
                        pointHoverBorderColor: "#fff",
                        fill: false,
                        datalabels: {
                            anchor: "end",
                            align: "top",
                            offset: 8,
                            color: "#6366f1",
                            font: {
                                size: 11,
                                weight: "bold"
                            },
                            formatter: (v) => v.toFixed(1) + "%"
                        }
                    },
                    {
                        label: "Cycle 2 Drop %",
                        data: c2,
                        tension: 0.4,
                        borderColor: "#ec4899",
                        backgroundColor: "rgba(236, 72, 153, 0.1)",
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: "#ec4899",
                        pointBorderColor: "#fff",
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: "#ec4899",
                        pointHoverBorderColor: "#fff",
                        fill: false,
                        datalabels: {
                            anchor: "start",
                            align: "bottom",
                            offset: 8,
                            color: "#ec4899",
                            font: {
                                size: 11,
                                weight: "bold"
                            },
                            formatter: (v) => v.toFixed(1) + "%"
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: isDark ? 'rgba(15, 15, 15, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                        titleColor: isDark ? '#fff' : '#0f172a',
                        bodyColor: isDark ? '#cbd5e1' : '#475569',
                        borderColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 12,
                        titleFont: {
                            size: 13,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 12
                        },
                        callbacks: {
                            label: (ctx) => ctx.dataset.label + ': ' + ctx.raw.toFixed(2) + "%"
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            color: isDark ? '#64748b' : '#94a3b8',
                            font: {
                                size: 11,
                                weight: '600'
                            },
                            padding: 8
                        },
                        border: {
                            color: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        min: 0,
                        max: Math.ceil(Math.max(...c1, ...c2) + 8),
                        ticks: {
                            callback: v => v + "%",
                            stepSize: 5,
                            color: isDark ? '#64748b' : '#94a3b8',
                            font: {
                                size: 11,
                                weight: '600'
                            },
                            padding: 12
                        },
                        grid: {
                            color: isDark ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.03)',
                            drawTicks: false
                        },
                        border: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: "Drop Percentage",
                            color: isDark ? '#94a3b8' : '#64748b',
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            padding: { bottom: 16 }
                        }
                    }
                }
            }
        });
    }
function buildRetention(data){
    
    let subjectsHolder = {};

    data.forEach(r=>{
        let sub = r.Subject;
        let cyc = r.Cycle;
        let partA = Number(r["Part A"]);
        let day = Number(r.Day.replace("Day-",""));

        if(!subjectsHolder[sub]) subjectsHolder[sub] = { c1:{}, c2:{} };

        let cycleGroup = cyc === "Cycle 1" ? subjectsHolder[sub].c1 : subjectsHolder[sub].c2;

        if(!cycleGroup.first || day === 1) cycleGroup.first = partA;
        if(!cycleGroup.last || cycleGroup.lastDay < day){
            cycleGroup.last = partA;
            cycleGroup.lastDay = day;
        }
    });

    let subjects = [];
    let bars = [];
    let line1 = [];
    let line2 = [];

    Object.entries(subjectsHolder).forEach(([sub,val])=>{

        let r1 = calculateRetention(val.c1.first,val.c1.last);
        let r2 = calculateRetention(val.c2.first,val.c2.last);

        subjects.push(sub);
        bars.push(((r1+r2)/2).toFixed(1));
        line1.push(r1.toFixed(1));
        line2.push(r2.toFixed(1));
    });

    renderRetentionChart(subjects,bars,line1,line2);
}
// NEW: Build First Day vs Last Day Chart
// NEW: Build First Day vs Last Day Chart - IMPROVED
function buildFirstLastComparison(data) {
    let subjectsHolder = {};

    data.forEach(r => {
        let sub = r.Subject;
        let cyc = r.Cycle;
        let partA = Number(r["Part A"]);
        let day = Number(r.Day.replace("Day-", ""));

        if (!partA || isNaN(partA)) return;

        let key = sub + "_" + cyc;

        if (!subjectsHolder[key]) {
            subjectsHolder[key] = {
                subject: sub,
                cycle: cyc,
                firstDay: 0,
                lastDay: 0,
                maxDay: 0
            };
        }

        subjectsHolder[key].maxDay = Math.max(subjectsHolder[key].maxDay, day);

        if (day === 1) {
            subjectsHolder[key].firstDay = partA;
        }
    });

    // Get last day values
    data.forEach(r => {
        let sub = r.Subject;
        let cyc = r.Cycle;
        let partA = Number(r["Part A"]);
        let day = Number(r.Day.replace("Day-", ""));
        let key = sub + "_" + cyc;

        if (subjectsHolder[key] && day === subjectsHolder[key].maxDay) {
            subjectsHolder[key].lastDay = partA;
        }
    });

    // Prepare chart data - Group by cycle for better visualization
    let cycle1Labels = [];
    let cycle1FirstDay = [];
    let cycle1LastDay = [];
    
    let cycle2Labels = [];
    let cycle2FirstDay = [];
    let cycle2LastDay = [];

    Object.values(subjectsHolder).forEach(item => {
        if (item.firstDay > 0 && item.lastDay > 0) {
            if (item.cycle === "Cycle 1") {
                cycle1Labels.push(item.subject);
                cycle1FirstDay.push(item.firstDay);
                cycle1LastDay.push(item.lastDay);
            } else if (item.cycle === "Cycle 2") {
                cycle2Labels.push(item.subject);
                cycle2FirstDay.push(item.firstDay);
                cycle2LastDay.push(item.lastDay);
            }
        }
    });

    // Determine which data to show based on cycle filter
    const cycleFilter = state.cycle;
    
    if (cycleFilter === "Cycle 1") {
        renderFirstLastChart(cycle1Labels, cycle1FirstDay, cycle1LastDay, "Cycle 1");
    } else if (cycleFilter === "Cycle 2") {
        renderFirstLastChart(cycle2Labels, cycle2FirstDay, cycle2LastDay, "Cycle 2");
    } else {
        // Show both cycles - combine data with cleaner labels
        let allLabels = [];
        let allFirstDay = [];
        let allLastDay = [];
        
        cycle1Labels.forEach((label, i) => {
            allLabels.push(label + " (C1)"); // â† CHANGED: Now shows (C1)
            allFirstDay.push(cycle1FirstDay[i]);
            allLastDay.push(cycle1LastDay[i]);
        });
        
        cycle2Labels.forEach((label, i) => {
            allLabels.push(label + " (C2)"); // â† CHANGED: Now shows (C2)
            allFirstDay.push(cycle2FirstDay[i]);
            allLastDay.push(cycle2LastDay[i]);
        });
        
        renderFirstLastChart(allLabels, allFirstDay, allLastDay, "Both Cycles");
    }
}

let firstLastChart = null;

function renderFirstLastChart(labels, firstDay, lastDay, cycleInfo = "All") {
    if (firstLastChart) firstLastChart.destroy();

    const ctx = document.getElementById("firstLastChart");
    if (!ctx) return;
    
    const isDark = document.documentElement.classList.contains('dark');

    // Calculate max value for better scaling
    const maxVal = Math.max(...firstDay, ...lastDay);
    const yMax = Math.ceil(maxVal * 1.2 / 100) * 100;

    firstLastChart = new Chart(ctx, {
        type: "line",
        plugins: [ChartDataLabels],
        data: {
            labels: labels,
            datasets: [
                {
                    label: "First Day",
                    data: firstDay,
                    tension: 0.4,
                    borderColor: "#6366f1",
                    backgroundColor: "rgba(99, 102, 241, 0.1)",
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: "#6366f1",
                    pointBorderColor: "#fff",
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: "#6366f1",
                    pointHoverBorderColor: "#fff",
                    fill: false,
                    datalabels: {
                        anchor: "end",
                        align: "top",
                        offset: 8,
                        color: "#6366f1",
                        font: {
                            size: 11,
                            weight: "bold"
                        },
                        formatter: (v) => v.toLocaleString()
                    }
                },
                {
                    label: "Last Day",
                    data: lastDay,
                    tension: 0.4,
                    borderColor: "#ec4899",
                    backgroundColor: "rgba(236, 72, 153, 0.1)",
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: "#ec4899",
                    pointBorderColor: "#fff",
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: "#ec4899",
                    pointHoverBorderColor: "#fff",
                    fill: false,
                    datalabels: {
                        anchor: "start",
                        align: "bottom",
                        offset: 8,
                        color: "#ec4899",
                        font: {
                            size: 11,
                            weight: "bold"
                        },
                        formatter: (v) => v.toLocaleString()
                    }
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(15, 15, 15, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                    titleColor: isDark ? '#fff' : '#0f172a',
                    bodyColor: isDark ? '#cbd5e1' : '#475569',
                    borderColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 12,
                    titleFont: {
                        size: 13,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    },
                    callbacks: {
                        title: (items) => {
                            return items[0].label.replace(' (C1)', '').replace(' (C2)', '');
                        },
                        label: (ctx) => ctx.dataset.label + ': ' + ctx.raw.toLocaleString(),
                        afterBody: (tooltipItems) => {
                            const dataIndex = tooltipItems[0].dataIndex;
                            const first = firstDay[dataIndex];
                            const last = lastDay[dataIndex];
                            const retention = ((last / first) * 100).toFixed(1);
                            const change = last - first;
                            const changeSign = change >= 0 ? '+' : '';
                            
                            return [
                                '',
                                `Retention: ${retention}%`,
                                `Change: ${changeSign}${change.toLocaleString()}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        color: isDark ? '#64748b' : '#94a3b8',
                        font: {
                            size: 11,
                            weight: '600'
                        },
                        padding: 8
                    },
                    border: {
                        color: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    min: 0,
                    max: yMax,
                    ticks: {
                        callback: v => v.toLocaleString(),
                        stepSize: Math.ceil(yMax / 10 / 100) * 100,
                        color: isDark ? '#64748b' : '#94a3b8',
                        font: {
                            size: 11,
                            weight: '600'
                        },
                        padding: 12
                    },
                    grid: {
                        color: isDark ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.03)',
                        drawTicks: false
                    },
                    border: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: "Number of Students",
                        color: isDark ? '#94a3b8' : '#64748b',
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        padding: { bottom: 16 }
                    }
                }
            }
        }
    });
}

let retentionChart = null;

function renderRetentionChart(x,bar,line1,line2){
    if(retentionChart) retentionChart.destroy();

    const ctx = document.getElementById("retentionChart");
    const isDark = document.documentElement.classList.contains('dark');
    
    retentionChart = new Chart(ctx,{
        type:"line",
        plugins:[ChartDataLabels],
        data:{
            labels:x,
            datasets:[
                {
                    type:"line",
                    label:"Cycle 1",
                    data:line1,
                    tension:0.3,
                    borderColor:"#6366f1",
                    backgroundColor:"rgba(99, 102, 241, 0.05)",
                    borderWidth: 4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: "#6366f1",
                    pointBorderColor: "#fff",
                    pointBorderWidth: 3,
                    pointHoverBackgroundColor: "#6366f1",
                    pointHoverBorderColor: "#fff",
                    fill:false,
                    datalabels:{
                        display: true,
                        align: (context) => {
                            const index = context.dataIndex;
                            const c1 = parseFloat(line1[index]);
                            const c2 = parseFloat(line2[index]);
                            return c1 > c2 ? 'top' : 'bottom';
                        },
                        offset: 8,
                        color: "#6366f1",
                        font: {
                            size: 10,
                            weight: "bold"
                        },
                        formatter:(v)=>v+"%"
                    }
                },
                {
                    type:"line",
                    label:"Cycle 2",
                    data:line2,
                    tension:0.3,
                    borderColor:"#ec4899",
                    backgroundColor:"rgba(236, 72, 153, 0.05)",
                    borderWidth: 4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: "#ec4899",
                    pointBorderColor: "#fff",
                    pointBorderWidth: 3,
                    pointHoverBackgroundColor: "#ec4899",
                    pointHoverBorderColor: "#fff",
                    fill:false,
                    datalabels:{
                        display: true,
                        align: (context) => {
                            const index = context.dataIndex;
                            const c1 = parseFloat(line1[index]);
                            const c2 = parseFloat(line2[index]);
                            return c2 > c1 ? 'top' : 'bottom';
                        },
                        offset: 8,
                        color: "#ec4899",
                        font: {
                            size: 10,
                            weight: "bold"
                        },
                        formatter:(v)=>v+"%"
                    }
                }
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins:{
                legend: { 
                    display: false
                },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(15, 15, 15, 0.98)' : 'rgba(255, 255, 255, 0.98)',
                    titleColor: isDark ? '#fff' : '#0f172a',
                    bodyColor: isDark ? '#cbd5e1' : '#475569',
                    borderColor: isDark ? 'rgba(99, 102, 241, 0.3)' : 'rgba(99, 102, 241, 0.2)',
                    borderWidth: 2,
                    padding: 16,
                    cornerRadius: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    displayColors: true,
                    callbacks: {
                        title: (items) => items[0].label,
                        label: (ctx) => {
                            return ctx.dataset.label + ': ' + ctx.raw + "%";
                        }
                    }
                }
            },
            scales:{
                y:{
                    beginAtZero:true,
                    max: 100,
                    ticks:{
                        callback:(v)=>v+"%",
                        color: isDark ? '#64748b' : '#94a3b8',
                        font: {
                            size: 12,
                            weight: '700'
                        },
                        padding: 12,
                        stepSize: 20
                    },
                    grid: {
                        color: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                        drawTicks: false,
                        lineWidth: 1
                    },
                    border: {
                        display: false
                    }
                },
                x:{
                    grid: {
                        display: false
                    },
                    ticks: { 
                        maxRotation:45,
                        minRotation:45,
                        color: isDark ? '#64748b' : '#94a3b8',
                        font: {
                            size: 11,
                            weight: '700'
                        },
                        padding: 10
                    },
                    border: {
                        color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
}

function calculateRetention(f,l){
    if(!f || !l) return 0;
    return (l/f)*100;
}

function calculateRetention(f,l){
    if(!f || !l) return 0;
    return (l/f)*100;
}

    function buildPollChart(data) {
        const container = document.getElementById('poll-chart-container');
        
        if (state.course !== 'NEET PG') {
            container.style.display = 'none';
            return;
        }

        let subjectPolls = {};
        
        data.forEach(r => {
            const sub = r.Subject;
            const polls = Number(r["Total Polls"]);
            
            if (!isNaN(polls)) {
                if (!subjectPolls[sub]) subjectPolls[sub] = 0;
                subjectPolls[sub] += polls;
            }
        });

        let sorted = Object.entries(subjectPolls)
            .sort((a, b) => b[1] - a[1])
            .filter(([_, count]) => count > 0);

        if (sorted.length === 0) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';

        let subjects = sorted.map(([sub, _]) => sub);
        let counts = sorted.map(([_, count]) => count);
        let total = counts.reduce((a, b) => a + b, 0);

        document.getElementById('total-polls-text').innerText = total.toLocaleString() + ' Total Polls';

        renderPollChart(subjects, counts);
    }

    function renderPollChart(subjects, counts) {
        if (pollChart) pollChart.destroy();

        const ctx = document.getElementById("pollChart");
        const isDark = document.documentElement.classList.contains('dark');

        const gradients = subjects.map((_, i) => {
            const grad = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
            const hue = (i * 360 / subjects.length);
            grad.addColorStop(0, `hsla(${hue}, 70%, 60%, 0.8)`);
            grad.addColorStop(1, `hsla(${hue}, 70%, 50%, 0.4)`);
            return grad;
        });

        pollChart = new Chart(ctx, {
            type: "bar",
            plugins: [ChartDataLabels],
            data: {
                labels: subjects,
                datasets: [{
                    label: "Total Polls",
                    data: counts,
                    backgroundColor: gradients,
                    borderColor: subjects.map((_, i) => {
                        const hue = (i * 360 / subjects.length);
                        return `hsl(${hue}, 70%, 50%)`;
                    }),
                    borderWidth: 2,
                    borderRadius: 12,
                    borderSkipped: false,
                    datalabels: {
                        anchor: "end",
                        align: "top",
                        offset: 4,
                        color: isDark ? '#cbd5e1' : '#475569',
                        font: {
                            size: 12,
                            weight: "bold"
                        },
                        formatter: (v) => v.toLocaleString()
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: isDark ? 'rgba(15, 15, 15, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                        titleColor: isDark ? '#fff' : '#0f172a',
                        bodyColor: isDark ? '#cbd5e1' : '#475569',
                        borderColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 12,
                        titleFont: {
                            size: 13,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 12
                        },
                        callbacks: {
                            label: (ctx) => 'Polls Conducted: ' + ctx.raw.toLocaleString()
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            color: isDark ? '#64748b' : '#94a3b8',
                            font: {
                                size: 11,
                                weight: '600'
                            },
                            padding: 8
                        },
                        border: {
                            color: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: isDark ? '#64748b' : '#94a3b8',
                            font: {
                                size: 11,
                                weight: '600'
                            },
                            padding: 12,
                            callback: (v) => v.toLocaleString()
                        },
                        grid: {
                            color: isDark ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.03)',
                            drawTicks: false
                        },
                        border: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: "Number of Polls",
                            color: isDark ? '#94a3b8' : '#64748b',
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            padding: { bottom: 16 }
                        }
                    }
                }
            }
        });
    }
    function openAttendance(){
    activePage = "attendance";
    
    // Update nav styling - Blue theme
    const navAtt = document.getElementById("nav-attendance");
    const navIss = document.getElementById("nav-issues");
    const navFac = document.getElementById("nav-faculty");
    
    navAtt.className = "nav-btn relative flex items-center gap-3 w-full px-4 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg shadow-blue-500/30 transition-all duration-300 hover:shadow-xl hover:shadow-blue-500/40 hover:scale-[1.02] group";
    
    navIss.className = "nav-btn relative flex items-center gap-3 w-full px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-white/[0.05] transition-all duration-300 group";
    
    navFac.className = "nav-btn relative flex items-center gap-3 w-full px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-white/[0.05] transition-all duration-300 group";
    
    // Show UI
    document.getElementById("attendance-ui").style.display = "block";
    document.getElementById("issues-ui").style.display = "none";
    document.getElementById("faculty-ui").style.display = "none";
    
    // Show skeleton immediately
    showKPISkeleton();
    document.getElementById('retention-value').innerHTML = '<div class="skeleton skeleton-text w-20 h-10 mx-auto"></div>';
    
    // Load data after a small delay
    setTimeout(() => {
        loadSheet();
    }, 100);
}
function populateCycleFilter(){
    console.log("ðŸ”„ Populating cycle filter...");

    let cycleSet = new Set();

    sheetData.forEach(r => {
        if(r.Cycle) {
            let cleanCycle = r.Cycle
                .trim()
                .replace(/['"]/g, '')
                .replace(/\s+/g, ' ');
            
            if(cleanCycle && cleanCycle !== '' && cleanCycle !== '-') {
                cycleSet.add(cleanCycle);
            }
        }
    });

    // Sort cycles numerically (Cycle 1, Cycle 2, etc.)
    let cycles = [...cycleSet].sort((a, b) => {
        const numA = parseInt(a.match(/\d+/)?.[0] || '0');
        const numB = parseInt(b.match(/\d+/)?.[0] || '0');
        return numA - numB;
    });

    console.log("âœ… Unique Cycles Found:", cycles);

    let select = document.getElementById("filter-cycle");
    select.innerHTML = `<option value="all">All Cycles</option>`;

    cycles.forEach(c => {
        let opt = document.createElement("option");
        opt.value = c;
        opt.innerText = c;
        select.appendChild(opt);
    });
    
    console.log("âœ… Cycle filter populated with", cycles.length, "cycles");
}
function populateFacultyFilter(){
    console.log("ðŸ”„ Populating faculty filter...");

    let facultySet = new Set();

    sheetData.forEach(r => {
        if(r.Faculty) {
            let cleanFaculty = r.Faculty
                .trim()
                .replace(/['"]/g, '')
                .replace(/\s+/g, ' ');
            
            if(cleanFaculty && cleanFaculty !== '' && cleanFaculty !== '-' && cleanFaculty.toLowerCase() !== 'unknown') {
                facultySet.add(cleanFaculty);
            }
        }
    });

    // Sort faculty alphabetically
    let faculties = [...facultySet].sort();

    console.log("âœ… Unique Faculty Found:", faculties);

    let select = document.getElementById("filter-faculty");
    select.innerHTML = `<option value="all">All Faculty</option>`;

    faculties.forEach(f => {
        let opt = document.createElement("option");
        opt.value = f;
        opt.innerText = f;
        select.appendChild(opt);
    });
    
    console.log("âœ… Faculty filter populated with", faculties.length, "faculty members");
}
function applyIssueFilters(){
    let selectedCourse = document.getElementById("filter-course").value;
    let selectedCycle = document.getElementById("filter-cycle").value;
    let selectedFaculty = document.getElementById("filter-faculty").value;
    let from = document.getElementById("filter-from").value;
    let to = document.getElementById("filter-to").value;

    console.log("\nðŸ” === APPLYING FILTERS ===");
    console.log("Selected Course:", `"${selectedCourse}"`);
    console.log("Selected Cycle:", `"${selectedCycle}"`);
    console.log("Selected Faculty:", `"${selectedFaculty}"`);
    console.log("From Date:", from);
    console.log("To Date:", to);

    let isFiltered = (selectedCourse !== "all" || selectedCycle !== "all" || selectedFaculty !== "all" || from !== "" || to !== "");

    if(isFiltered){
        showResetBtn();
    } else {
        hideResetBtn();
    }

    let filtered = sheetData.filter(r => {
        // Skip empty rows
        if(!r.Date || r.Date.trim() === "") return false;
        if(!r.Course || r.Course.trim() === "") return false;
        if(!r.Category || r.Category.trim() === "") return false;

        // Course filter
        if(selectedCourse !== "all") {
            let rowCourse = r.Course
                .trim()
                .replace(/['"]/g, '')
                .replace(/\s+/g, ' ');
            
            let filterCourse = selectedCourse
                .trim()
                .replace(/['"]/g, '')
                .replace(/\s+/g, ' ');
            
            let matches = rowCourse === filterCourse;
            
            console.log(`Comparing: "${rowCourse}" === "${filterCourse}" â†’ ${matches}`);
            
            if(!matches) return false;
        }

        // Cycle filter
        if(selectedCycle !== "all") {
            let rowCycle = r.Cycle
                ? r.Cycle.trim().replace(/['"]/g, '').replace(/\s+/g, ' ')
                : '';
            
            let filterCycle = selectedCycle
                .trim()
                .replace(/['"]/g, '')
                .replace(/\s+/g, ' ');
            
            if(rowCycle !== filterCycle) return false;
        }

        // Faculty filter
        if(selectedFaculty !== "all") {
            let rowFaculty = r.Faculty
                ? r.Faculty.trim().replace(/['"]/g, '').replace(/\s+/g, ' ')
                : '';
            
            let filterFaculty = selectedFaculty
                .trim()
                .replace(/['"]/g, '')
                .replace(/\s+/g, ' ');
            
            if(rowFaculty !== filterFaculty) return false;
        }

        // Date from filter
        if(from && from !== ""){
            let rowDate = new Date(r.Date.trim());
            let fromDate = new Date(from);
            fromDate.setHours(0, 0, 0, 0);
            
            if(rowDate < fromDate) return false;
        }

        // Date to filter
        if(to && to !== ""){
            let rowDate = new Date(r.Date.trim());
            let toDate = new Date(to);
            toDate.setHours(23, 59, 59, 999);
            
            if(rowDate > toDate) return false;
        }

        return true;
    });

    console.log("âœ… Filtered Results:", filtered.length, "rows");
    console.log("Sample row for debugging:", filtered[0]);
    console.log("======================\n");

    buildIssuesAnalytics(filtered);
}
function resetIssueFilters(){
    document.getElementById("filter-course").value = "all";
    document.getElementById("filter-cycle").value = "all";
    document.getElementById("filter-faculty").value = "all";
    document.getElementById("filter-from").value = "";
    document.getElementById("filter-to").value = "";
    
    hideResetBtn();
    buildIssuesAnalytics(sheetData);
}

function setQuickDays(n){
    let today = new Date();
    let past = new Date();
    past.setDate(today.getDate() - n);

    // Format dates as YYYY-MM-DD
    let formatDate = (date) => {
        let year = date.getFullYear();
        let month = String(date.getMonth() + 1).padStart(2, '0');
        let day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    let fromDate = formatDate(past);
    let toDate = formatDate(today);

    console.log("Quick Filter:", n, "days - From:", fromDate, "To:", toDate);

    document.getElementById("filter-from").value = fromDate;
    document.getElementById("filter-to").value = toDate;

    showResetBtn();
    applyIssueFilters();
}
function showResetBtn(){
    document.getElementById("filter-reset").classList.remove("hidden");
}

function hideResetBtn(){
    document.getElementById("filter-reset").classList.add("hidden");
}


function buildIssuesAnalytics(data = sheetData){
    
    console.log("ðŸŽ¨ Building Issues Analytics...");
    console.log("Data length:", data ? data.length : 0);

    // Filter out empty rows and rows without essential data
    const validData = data.filter(r => {
        return r.Date && r.Date.trim() !== "" && 
               r.Course && r.Course.trim() !== "" &&
               r.Category && r.Category.trim() !== "";
    });

    console.log("Valid data length:", validData.length);

    // Calculate KPIs
    const totalIssues = validData.length;
    
    // Top category - exclude "Unknown" and empty values
    let categoryCount = {};
    validData.forEach(r => {
        let cat = r.Category ? r.Category.trim() : "";
        if(cat && cat !== "" && cat.toLowerCase() !== "unknown"){
            categoryCount[cat] = (categoryCount[cat] || 0) + 1;
        }
    });
    
    let topCategory = Object.entries(categoryCount)
        .sort((a,b) => b[1] - a[1])[0];
    
    // Top faculty - exclude "Unknown" and empty values
    let facultyCount = {};
    validData.forEach(r => {
        let fac = r.Faculty ? r.Faculty.trim() : "";
        if(fac && fac !== "" && fac.toLowerCase() !== "unknown"){
            facultyCount[fac] = (facultyCount[fac] || 0) + 1;
        }
    });
    
    let topFaculty = Object.entries(facultyCount)
        .sort((a,b) => b[1] - a[1])[0];
    
    // Top place - exclude "Unknown" and empty values
    let placeCount = {};
    validData.forEach(r => {
        let place = r.Place ? r.Place.trim() : "";
        if(place && place !== "" && place.toLowerCase() !== "unknown"){
            placeCount[place] = (placeCount[place] || 0) + 1;
        }
    });
    
    let topPlace = Object.entries(placeCount)
        .sort((a,b) => b[1] - a[1])[0];

    console.log("KPIs calculated:", { totalIssues, topCategory, topFaculty, topPlace });

    // Update KPIs
    const totalEl = document.getElementById("kpi-total-issues");
    const catEl = document.getElementById("kpi-top-category");
    const facEl = document.getElementById("kpi-top-faculty");
    const placeEl = document.getElementById("kpi-top-place");

    if(totalEl) totalEl.innerText = totalIssues;
    if(catEl) catEl.innerText = topCategory ? `${topCategory[0]} (${topCategory[1]})` : "No Data";
    if(facEl) facEl.innerText = topFaculty ? `${topFaculty[0]} (${topFaculty[1]})` : "No Data";
    if(placeEl) placeEl.innerText = topPlace ? `${topPlace[0]} (${topPlace[1]})` : "No Data";

    console.log("KPIs updated in DOM");

    // Build Charts with filtered data
    try {
        console.log("Building pie chart...");
        buildIssuesPieChart(categoryCount);
        console.log("âœ… Pie chart built");
        
        console.log("Building faculty chart...");
        buildIssuesFacultyChart(facultyCount);
        console.log("âœ… Faculty chart built");
        
        console.log("Building month chart...");
        buildIssuesMonthChart(validData);
        console.log("âœ… Month chart built");
    } catch(err) {
        console.error("âŒ Error building charts:", err);
    }
    
    console.log("âœ… Issues Analytics Complete!");
}

function populateCourseFilter(){
    console.log("ðŸ”„ Populating course filter...");
    console.log("ðŸ“Š Total rows:", sheetData.length);

    let courseSet = new Set();

    sheetData.forEach((r, idx) => {
        if(r.Course) {
            // Clean the course name thoroughly
            let cleanCourse = r.Course
                .trim()
                .replace(/['"]/g, '')
                .replace(/\s+/g, ' ');
            
            if(cleanCourse && cleanCourse !== '' && cleanCourse !== '-') {
                courseSet.add(cleanCourse);
                if(idx < 5) {
                    console.log(`Row ${idx} Course: "${cleanCourse}"`);
                }
            }
        }
    });

    let courses = [...courseSet].sort();
    console.log("âœ… Unique Courses Found:", courses);

    let select = document.getElementById("filter-course");
    select.innerHTML = `<option value="all">All Courses</option>`;

    courses.forEach(c => {
        let opt = document.createElement("option");
        opt.value = c;
        opt.innerText = c;
        select.appendChild(opt);
    });
    
    console.log("âœ… Course filter populated with", courses.length, "courses");
}

function openIssues(){
    activePage = "issues";
    
    // Update nav styling - Blue theme
    const navAtt = document.getElementById("nav-attendance");
    const navIss = document.getElementById("nav-issues");
    const navFac = document.getElementById("nav-faculty");
    
    navIss.className = "nav-btn relative flex items-center gap-3 w-full px-4 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg shadow-blue-500/30 transition-all duration-300 hover:shadow-xl hover:shadow-blue-500/40 hover:scale-[1.02] group";
    
    navAtt.className = "nav-btn relative flex items-center gap-3 w-full px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-white/[0.05] transition-all duration-300 group";
    
    navFac.className = "nav-btn relative flex items-center gap-3 w-full px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-white/[0.05] transition-all duration-300 group";
    
    // Show UI
    document.getElementById("attendance-ui").style.display = "none";
    document.getElementById("issues-ui").style.display = "block";
    document.getElementById("faculty-ui").style.display = "none";
    
    // Show skeleton immediately
    document.getElementById("issue-table").innerHTML = showIssuesKPISkeleton() + showIssuesChartsSkeleton();
    lucide.createIcons();
    
    // Load data after a small delay
    setTimeout(() => {
        loadSheet();
setTimeout(() => {
    populateCourseFilter();
    populateCycleFilter();
    populateFacultyFilter();
}, 300);    }, 100);
}
function toggleRawIssues(){
    const div = document.getElementById("rawIssuesContainer");
    const btn = event.target.closest('button');

    if(div.classList.contains("hidden")){
        div.classList.remove("hidden");
        div.innerHTML = buildIssuesRawTable();
        
        // Initialize DataTable with Excel-like filters
        setTimeout(() => {
            $('#issuesDataTable').DataTable({
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                order: [[0, 'desc']], // Sort by first column (Date) descending
                language: {
                    search: "ðŸ” Search:",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ issues",
                    infoEmpty: "No issues found",
                    infoFiltered: "(filtered from _MAX_ total issues)",
                    paginate: {
                        first: "â®",
                        last: "â­",
                        next: "â–¶",
                        previous: "â—€"
                    }
                },
                initComplete: function () {
                    // Add column filters
                    this.api().columns().every(function () {
                        let column = this;
                        let title = column.header().textContent;
                        
                        // Create select dropdown
                        let select = document.createElement('select');
                        select.className = 'w-full mt-2 px-2 py-1.5 text-xs rounded-lg border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 focus:ring-2 focus:ring-purple-500/50 outline-none';
                        select.innerHTML = '<option value="">All</option>';
                        column.header().appendChild(select);
 
                        // Populate with unique values
                        column.data().unique().sort().each(function (d) {
                            if (d) {
                                select.innerHTML += `<option value="${d}">${d}</option>`;
                            }
                        });
 
                        // Filter on change
                        select.addEventListener('change', function () {
                            let val = this.value;
                            column.search(val ? '^' + val + '$' : '', true, false).draw();
                        });
                    });
                }
            });
        }, 100);
        
        // Update button to show "Hide" state
        btn.innerHTML = `
            <i data-lucide="x" class="w-3.5 h-3.5"></i>
            Hide Raw Data
        `;
        btn.classList.add('text-red-600', 'dark:text-red-400', 'hover:text-red-700', 'dark:hover:text-red-300', 'hover:border-red-500/50');
        btn.classList.remove('text-slate-600', 'dark:text-slate-400', 'hover:text-indigo-600', 'dark:hover:text-indigo-400', 'hover:border-indigo-500/50');
        
        lucide.createIcons();
    } else {
        // Destroy DataTable before hiding
        if ($.fn.DataTable.isDataTable('#issuesDataTable')) {
            $('#issuesDataTable').DataTable().destroy();
        }
        
        div.classList.add("hidden");
        
        // Update button to show "Show" state
        btn.innerHTML = `
            <i data-lucide="database" class="w-3.5 h-3.5"></i>
            View Raw Data
        `;
        btn.classList.remove('text-red-600', 'dark:text-red-400', 'hover:text-red-700', 'dark:hover:text-red-300', 'hover:border-red-500/50');
        btn.classList.add('text-slate-600', 'dark:text-slate-400', 'hover:text-indigo-600', 'dark:hover:text-indigo-400', 'hover:border-indigo-500/50');
        
        lucide.createIcons();
    }
}
function buildIssuesRawTable(){
    let html = `
    <div class="rounded-2xl shadow-2xl border border-slate-200/80 dark:border-white/10 overflow-hidden bg-white dark:bg-gray-900/50 backdrop-blur-xl">
        <div class="overflow-x-auto">
            <table id="issuesDataTable" class="min-w-full text-sm display stripe hover" style="width:100%">
                <thead class="sticky top-0 z-10">
                    <tr class="bg-gradient-to-r from-violet-50 to-purple-50 dark:from-violet-900/20 dark:to-purple-900/20 border-b-2 border-violet-200 dark:border-violet-800">
    `;
    
    // Add headers with proper DataTables structure
    Object.keys(sheetData[0]).forEach(h=>{
        html += `<th class="px-6 py-4 text-left text-xs font-black uppercase tracking-wider text-slate-700 dark:text-slate-300">${h}</th>`;
    });

    html += `</tr></thead><tbody>`;

    // Add data rows
    sheetData.forEach((r, idx) => {
        const rowClass = idx % 2 === 0 
            ? 'bg-white dark:bg-transparent' 
            : 'bg-slate-50/50 dark:bg-white/[0.02]';
        
        html += `<tr class="${rowClass}">`;
        Object.values(r).forEach(v=>{
            html += `<td class="px-6 py-4 text-slate-600 dark:text-slate-400 font-medium whitespace-nowrap">${v}</td>`;
        });
        html += `</tr>`;
    });

    html += `</tbody></table></div></div>`;

    return html;
}
let issuesPieChart = null;
let issuesFacultyChart = null;
let issuesMonthChart = null;
let issuesTimelineView = 'monthly';

function buildIssuesAnalytics(data = sheetData){

    // Filter out empty rows and rows without essential data
    const validData = data.filter(r => {
        return r.Date && r.Date.trim() !== "" && 
               r.Course && r.Course.trim() !== "" &&
               r.Category && r.Category.trim() !== "";
    });

    // Calculate KPIs
    const totalIssues = validData.length;
    
    // Top category - exclude "Unknown" and empty values
    let categoryCount = {};
    validData.forEach(r => {
        let cat = r.Category ? r.Category.trim() : "";
        if(cat && cat !== "" && cat.toLowerCase() !== "unknown"){
            categoryCount[cat] = (categoryCount[cat] || 0) + 1;
        }
    });
    
    let topCategory = Object.entries(categoryCount)
        .sort((a,b) => b[1] - a[1])[0];
    
    // Top faculty - exclude "Unknown" and empty values
    let facultyCount = {};
    validData.forEach(r => {
        let fac = r.Faculty ? r.Faculty.trim() : "";
        if(fac && fac !== "" && fac.toLowerCase() !== "unknown"){
            facultyCount[fac] = (facultyCount[fac] || 0) + 1;
        }
    });
    
    let topFaculty = Object.entries(facultyCount)
        .sort((a,b) => b[1] - a[1])[0];
    
    // Top place - exclude "Unknown" and empty values
    let placeCount = {};
    validData.forEach(r => {
        let place = r.Place ? r.Place.trim() : "";
        if(place && place !== "" && place.toLowerCase() !== "unknown"){
            placeCount[place] = (placeCount[place] || 0) + 1;
        }
    });
    
    let topPlace = Object.entries(placeCount)
        .sort((a,b) => b[1] - a[1])[0];

    // Update KPIs
    document.getElementById("kpi-total-issues").innerText = totalIssues;
    const totalIssuesChart = document.getElementById("total-issues-chart");
if (totalIssuesChart) totalIssuesChart.textContent = totalIssues.toLocaleString() + ' Total Issues';
    document.getElementById("kpi-top-category").innerText = topCategory ? `${topCategory[0]} (${topCategory[1]})` : "No Data";
    document.getElementById("kpi-top-faculty").innerText = topFaculty ? `${topFaculty[0]} (${topFaculty[1]})` : "No Data";
    document.getElementById("kpi-top-place").innerText = topPlace ? `${topPlace[0]} (${topPlace[1]})` : "No Data";

    // Build Charts with filtered data
    buildIssuesPieChart(categoryCount);
    buildIssuesFacultyChart(facultyCount);
    buildIssuesMonthChart(validData);
}
function buildIssuesPieChart(categoryCount){
    if(issuesPieChart) issuesPieChart.destroy();

    const ctx = document.getElementById("issuesPieChart");
    const isDark = document.documentElement.classList.contains('dark');

    const labels = Object.keys(categoryCount);
    const values = Object.values(categoryCount);
    const total = values.reduce((a,b) => a+b, 0);

    // Sort by value descending and take top 10
    const sorted = labels.map((label, i) => ({
        label: label,
        value: values[i],
        percentage: ((values[i] / total) * 100).toFixed(1)
    })).sort((a, b) => b.value - a.value).slice(0, 10);

    issuesPieChart = new Chart(ctx, {
        type: "bar",
        plugins: [ChartDataLabels],
        data: {
            labels: sorted.map(s => s.label),
            datasets: [{
                label: "Issues",
                data: sorted.map(s => s.value),
                backgroundColor: sorted.map((_, i) => {
                    const grad = ctx.getContext('2d').createLinearGradient(0, 0, 600, 0);
                    const hue = 260 - (i * 20); // Purple to pink gradient
                    grad.addColorStop(0, `hsla(${hue}, 70%, 60%, 0.9)`);
                    grad.addColorStop(1, `hsla(${hue}, 70%, 50%, 0.6)`);
                    return grad;
                }),
                borderRadius: 12,
                borderSkipped: false,
                barThickness: 35,
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    offset: 8,
                    color: isDark ? '#e2e8f0' : '#475569',
                    font: {
                        size: 13,
                        weight: 'bold'
                    },
                    formatter: (value, ctx) => {
                        const percentage = sorted[ctx.dataIndex].percentage;
                        return `${value} (${percentage}%)`;
                    }
                }
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    left: 10,
                    right: 80,
                    top: 10,
                    bottom: 10
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(15, 15, 15, 0.98)' : 'rgba(255, 255, 255, 0.98)',
                    titleColor: isDark ? '#fff' : '#0f172a',
                    bodyColor: isDark ? '#cbd5e1' : '#475569',
                    borderColor: isDark ? 'rgba(168, 85, 247, 0.3)' : 'rgba(168, 85, 247, 0.2)',
                    borderWidth: 2,
                    padding: 16,
                    cornerRadius: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: (ctx) => {
                            const item = sorted[ctx.dataIndex];
                            const impact = getImpactLevel(parseFloat(item.percentage));
                            return [
                                `Total Issues: ${item.value}`,
                                `Percentage: ${item.percentage}%`,
                                `Impact: ${impact}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                        drawTicks: false
                    },
                    ticks: {
                        color: isDark ? '#64748b' : '#94a3b8',
                        font: {
                            size: 12,
                            weight: '700'
                        },
                        padding: 12,
                        callback: (v) => v.toLocaleString()
                    },
                    border: {
                        display: false
                    }
                },
                y: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: isDark ? '#cbd5e1' : '#475569',
                        font: {
                            size: 13,
                            weight: '700'
                        },
                        padding: 12,
                        autoSkip: false
                    },
                    border: {
                        color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
}

// Helper function for impact level
function getImpactLevel(percentage) {
    if (percentage >= 30) return 'ðŸ”´ Critical';
    if (percentage >= 20) return 'ðŸŸ  High';
    if (percentage >= 10) return 'ðŸŸ¡ Medium';
    return 'ðŸŸ¢ Low';
}

function buildIssuesFacultyChart(facultyCount){
    if(issuesFacultyChart) issuesFacultyChart.destroy();

    const ctx = document.getElementById("issuesFacultyChart");
    const isDark = document.documentElement.classList.contains('dark');

    const sorted = Object.entries(facultyCount).sort((a,b) => b[1] - a[1]).slice(0, 8);
    const labels = sorted.map(([name, _]) => name);
    const values = sorted.map(([_, count]) => count);

    issuesFacultyChart = new Chart(ctx, {
        type: "bar",
        plugins: [ChartDataLabels],
        data: {
            labels: labels,
            datasets: [{
                label: "Issues Count",
                data: values,
                backgroundColor: labels.map((_, i) => {
                    const grad = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
                    const hue = 240 - (i * 15);
                    grad.addColorStop(0, `hsla(${hue}, 70%, 60%, 0.9)`);
                    grad.addColorStop(1, `hsla(${hue}, 70%, 50%, 0.5)`);
                    return grad;
                }),
                borderRadius: 12,
                borderSkipped: false,
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    offset: 8,
                    color: isDark ? '#cbd5e1' : '#475569',
                    font: {
                        size: 12,
                        weight: 'bold'
                    },
                    formatter: (value) => value
                }
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    left: 0,
                    right: 40,
                    top: 10,
                    bottom: 10
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(15, 15, 15, 0.98)' : 'rgba(255, 255, 255, 0.98)',
                    titleColor: isDark ? '#fff' : '#0f172a',
                    bodyColor: isDark ? '#cbd5e1' : '#475569',
                    borderColor: isDark ? 'rgba(99, 102, 241, 0.3)' : 'rgba(99, 102, 241, 0.2)',
                    borderWidth: 2,
                    padding: 16,
                    cornerRadius: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: (ctx) => `Total Issues: ${ctx.raw}`
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: isDark ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.03)',
                        drawTicks: false
                    },
                    ticks: {
                        color: isDark ? '#64748b' : '#94a3b8',
                        font: { size: 12, weight: '700' },
                        padding: 12
                    },
                    border: {
                        display: false
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: {
                        color: isDark ? '#64748b' : '#94a3b8',
                        font: { size: 11, weight: '700' },
                        padding: 12,
                        autoSkip: false
                    },
                    border: {
                        color: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
}

function buildIssuesMonthChart(data){
    if(issuesMonthChart) issuesMonthChart.destroy();

    const ctx = document.getElementById("issuesMonthChart");
    const isDark = document.documentElement.classList.contains('dark');

    let timeCount = {};
    
    data.forEach(r => {
        const dt = new Date(r.Date);
        if(dt.toString() !== "Invalid Date"){
            let key, label, sortKey;
            
            if(issuesTimelineView === 'daily') {
                // Daily view - use date as key
                key = dt.toISOString().split('T')[0];
                label = dt.toLocaleString("en", { month: "short", day: "numeric" });
                sortKey = dt.getTime(); // Use timestamp for sorting
            } else if(issuesTimelineView === 'weekly') {
                // Weekly view - use Week column from sheet
                const weekNum = r.Week || r.week || r['Week'] || getWeekNumber(dt);
                const monthNum = r.Month || r.month || r['Month'] || (dt.getMonth() + 1);
                const year = dt.getFullYear();
                key = `${year}-${String(monthNum).padStart(2, '0')}-W${weekNum}`;
                label = `Week ${weekNum}`;
                sortKey = `${year}-${String(monthNum).padStart(2, '0')}-${String(weekNum).padStart(2, '0')}`;
            } else {
                // Monthly view - use Month column from sheet
                const monthNum = r.Month || r.month || r['Month'] || (dt.getMonth() + 1);
                const year = dt.getFullYear();
                key = `${year}-${String(monthNum).padStart(2, '0')}`;
                label = new Date(year, monthNum - 1, 1).toLocaleString("en", { month: "short", year: "numeric" });
                sortKey = `${year}-${String(monthNum).padStart(2, '0')}`;
            }
            
            if(!timeCount[key]) {
                timeCount[key] = { count: 0, label: label, sortKey: sortKey };
            }
            timeCount[key].count++;
        }
    });

    // Sort chronologically
    let sorted = Object.entries(timeCount).sort((a, b) => {
        return a[1].sortKey.toString().localeCompare(b[1].sortKey.toString());
    });

    // Limit data based on view
    if(issuesTimelineView === 'daily') {
        // Show last 10 days
        sorted = sorted.slice(-10);
    } else if(issuesTimelineView === 'weekly') {
        // Show last 12 weeks
        sorted = sorted.slice(-12);
    }
    // Monthly shows all data

    const labels = sorted.map(([_, data]) => data.label);
    const values = sorted.map(([_, data]) => data.count);

    issuesMonthChart = new Chart(ctx, {
        type: "line",
        plugins: [ChartDataLabels],
        data: {
            labels: labels,
            datasets: [{
                label: "Issues Count",
                data: values,
                tension: 0.4,
                borderColor: "#6366f1",
                backgroundColor: "rgba(99, 102, 241, 0.15)",
                borderWidth: 4,
                pointRadius: 6,
                pointHoverRadius: 9,
                pointBackgroundColor: "#6366f1",
                pointBorderColor: "#fff",
                pointBorderWidth: 3,
                pointHoverBackgroundColor: "#6366f1",
                pointHoverBorderColor: "#fff",
                fill: true,
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    offset: 8,
                    color: isDark ? '#cbd5e1' : '#475569',
                    font: {
                        size: 12,
                        weight: 'bold'
                    },
                    formatter: (value) => value
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 30,
                    right: 20,
                    bottom: 10,
                    left: 10
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(15, 15, 15, 0.98)' : 'rgba(255, 255, 255, 0.98)',
                    titleColor: isDark ? '#fff' : '#0f172a',
                    bodyColor: isDark ? '#cbd5e1' : '#475569',
                    borderColor: isDark ? 'rgba(99, 102, 241, 0.3)' : 'rgba(99, 102, 241, 0.2)',
                    borderWidth: 2,
                    padding: 16,
                    cornerRadius: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: (ctx) => `Issues: ${ctx.raw}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: isDark ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.03)',
                        drawTicks: false
                    },
                    ticks: {
                        color: isDark ? '#64748b' : '#94a3b8',
                        font: { size: 12, weight: '700' },
                        padding: 12,
                        stepSize: Math.max(1, Math.ceil(Math.max(...values) / 5))
                    },
                    border: {
                        display: false
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        color: isDark ? '#64748b' : '#94a3b8',
                        font: { size: 11, weight: '700' },
                        padding: 10,
                        autoSkip: true,
                        maxTicksLimit: issuesTimelineView === 'daily' ? 10 : 15
                    },
                    border: {
                        color: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
}

// Helper function to calculate week number
function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}

// Function to handle view changes
function setIssuesTimelineView(view) {
    issuesTimelineView = view;
    
    // Update button styles
    ['daily', 'weekly', 'monthly'].forEach(v => {
        const btn = document.getElementById(`timeline-${v}-btn`);
        if(btn) {
            if(v === view) {
                btn.classList.add('bg-white', 'dark:bg-gray-800', 'text-purple-600', 'dark:text-purple-400', 'shadow-md');
                btn.classList.remove('text-gray-600', 'dark:text-gray-400');
            } else {
                btn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-purple-600', 'dark:text-purple-400', 'shadow-md');
                btn.classList.add('text-gray-600', 'dark:text-gray-400');
            }
        }
    });
    
    // Rebuild chart with current filters
    applyIssueFilters();
}
// function buildIssuesMonthChart(data){
//     if(issuesMonthChart) issuesMonthChart.destroy();

//     const ctx = document.getElementById("issuesMonthChart");
//     const isDark = document.documentElement.classList.contains('dark');

//     let monthCount = {};
//     data.forEach(r => {
//         const dt = new Date(r.Date);
//         if(dt.toString() !== "Invalid Date"){
//             const monthYear = dt.toLocaleString("en", { month: "short", year: "numeric" });
//             monthCount[monthYear] = (monthCount[monthYear] || 0) + 1;
//         }
//     });

//     const sorted = Object.entries(monthCount).sort((a,b) => {
//         return new Date(a[0]) - new Date(b[0]);
//     });

//     const labels = sorted.map(([m, _]) => m);
//     const values = sorted.map(([_, c]) => c);

//     issuesMonthChart = new Chart(ctx, {
//         type: "line",
//         data: {
//             labels: labels,
//             datasets: [{
//                 label: "Issues Per Month",
//                 data: values,
//                 tension: 0.4,
//                 borderColor: "#6366f1",
//                 backgroundColor: "rgba(99, 102, 241, 0.1)",
//                 borderWidth: 3,
//                 pointRadius: 5,
//                 pointHoverRadius: 7,
//                 pointBackgroundColor: "#6366f1",
//                 pointBorderColor: "#fff",
//                 pointBorderWidth: 2,
//                 fill: true
//             }]
//         },
//         options: {
//             responsive: true,
//             maintainAspectRatio: false,
//             plugins: {
//                 legend: { display: false },
//                 tooltip: {
//                     backgroundColor: isDark ? 'rgba(15, 15, 15, 0.95)' : 'rgba(255, 255, 255, 0.95)',
//                     titleColor: isDark ? '#fff' : '#0f172a',
//                     bodyColor: isDark ? '#cbd5e1' : '#475569',
//                     borderColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
//                     borderWidth: 1,
//                     padding: 12,
//                     cornerRadius: 12
//                 }
//             },
//             scales: {
//                 y: {
//                     beginAtZero: true,
//                     grid: {
//                         color: isDark ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.03)'
//                     },
//                     ticks: {
//                         color: isDark ? '#64748b' : '#94a3b8',
//                         font: { size: 11, weight: '600' }
//                     }
//                 },
//                 x: {
//                     grid: { display: false },
//                     ticks: {
//                         maxRotation: 45,
//                         minRotation: 45,
//                         color: isDark ? '#64748b' : '#94a3b8',
//                         font: { size: 11, weight: '600' }
//                     }
//                 }
//             }
//         }
//     });
// }
function highlightSidebar(page){
    document.getElementById("active-attendance").style.display =
        (page === "attendance") ? "block" : "none";

    document.getElementById("active-issues").style.display =
        (page === "issues") ? "block" : "none";
}

// Skeleton Loading Components
function showKPISkeleton() {
    const container = document.getElementById('kpi-container');
    container.innerHTML = Array(4).fill(0).map((_, index) => {
        const delay = 0.3 + (index * 0.1);
        return `
        <div class="kpi-card p-8 rounded-3xl bg-white/90 dark:bg-[#0a0a0a] border border-slate-200/80 dark:border-white/5 card-shadow animate-fade-in-up" style="animation-delay: ${delay}s;">
            <div class="skeleton skeleton-circle w-16 h-16 mb-6"></div>
            <div class="space-y-3">
                <div class="skeleton skeleton-text w-24"></div>
                <div class="skeleton skeleton-text w-32 h-10"></div>
            </div>
        </div>
        `;
    }).join('');
}

function showChartSkeleton(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = `
        <div class="skeleton skeleton-chart"></div>
    `;
}

function showIssuesKPISkeleton() {
    return `
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
        ${Array(4).fill(0).map((_, i) => `
        <div class="glass p-6 rounded-3xl border border-slate-200/50 dark:border-white/10 text-center card-shadow animate-fade-in-up" style="animation-delay: ${i * 0.1}s;">
            <div class="skeleton skeleton-circle w-14 h-14 mx-auto mb-4"></div>
            <div class="skeleton skeleton-text h-8 w-20 mx-auto mb-2"></div>
            <div class="skeleton skeleton-text h-4 w-32 mx-auto"></div>
        </div>
        `).join('')}
    </div>
    `;
}

function showIssuesChartsSkeleton() {
    return `
    <!-- PIE CHART SKELETON -->
    <div class="glass p-8 rounded-3xl border border-slate-200/50 dark:border-white/10 mb-10 card-shadow animate-fade-in-up" style="animation-delay: 0.2s;">
        <div class="flex items-center gap-4 mb-8">
            <div class="skeleton skeleton-circle w-14 h-14"></div>
            <div class="flex-1">
                <div class="skeleton skeleton-text h-6 w-48 mb-2"></div>
                <div class="skeleton skeleton-text h-4 w-64"></div>
            </div>
        </div>
        <div class="skeleton skeleton-chart"></div>
    </div>

    <!-- CHART ROW SKELETON -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
        ${Array(2).fill(0).map((_, i) => `
        <div class="glass p-8 rounded-3xl border border-slate-200/50 dark:border-white/10 card-shadow animate-fade-in-up" style="animation-delay: ${0.3 + (i * 0.1)}s;">
            <div class="flex items-center gap-4 mb-8">
                <div class="skeleton skeleton-circle w-14 h-14"></div>
                <div class="flex-1">
                    <div class="skeleton skeleton-text h-6 w-40 mb-2"></div>
                    <div class="skeleton skeleton-text h-4 w-48"></div>
                </div>
            </div>
            <div class="skeleton skeleton-chart"></div>
        </div>
        `).join('')}
    </div>
    `;
}
// ==================== FACULTY HUB FUNCTIONS ====================

function openFacultyHub() {
    activePage = "faculty";
    
    // Update nav styling
    const navAtt = document.getElementById("nav-attendance");
    const navIss = document.getElementById("nav-issues");
    const navFac = document.getElementById("nav-faculty");
    
    navFac.className = "nav-btn relative flex items-center gap-3 w-full px-4 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg shadow-blue-500/30 transition-all duration-300 hover:shadow-xl hover:shadow-blue-500/40 hover:scale-[1.02] group";
    
    navAtt.className = "nav-btn relative flex items-center gap-3 w-full px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-white/[0.05] transition-all duration-300 group";
    
    navIss.className = "nav-btn relative flex items-center gap-3 w-full px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-white/[0.05] transition-all duration-300 group";
    
    // Show UI
    document.getElementById("attendance-ui").style.display = "none";
    document.getElementById("issues-ui").style.display = "none";
    document.getElementById("faculty-ui").style.display = "block";
    
    // Initialize Faculty Hub
    initFacultyHub();
    lucide.createIcons();
}

function initFacultyHub() {
    loadFacultyData();
    renderFacultyChips();
    renderAdminPanel();
}

function loadFacultyData() {
    const stored = localStorage.getItem('facultyAppreciations');
    if (!stored) {
        localStorage.setItem('facultyAppreciations', JSON.stringify({}));
    }
}

function getFacultyData() {
    return JSON.parse(localStorage.getItem('facultyAppreciations') || '{}');
}

function saveFacultyData(data) {
    localStorage.setItem('facultyAppreciations', JSON.stringify(data));
}


// Faculty Hub - New Implementation
let currentFacultyId = null;
let currentScreenshotIndex = 0;
let currentScreenshots = [];

function initFacultyHub() {
    loadFacultyData();
    renderFacultyGrid();
    renderAdminPanel();
    updateFacultyStats();
}

function loadFacultyData() {
    const stored = localStorage.getItem('facultyAppreciations');
    if (!stored) {
        localStorage.setItem('facultyAppreciations', JSON.stringify({}));
    }
}

function getFacultyData() {
    return JSON.parse(localStorage.getItem('facultyAppreciations') || '{}');
}

function saveFacultyData(data) {
    localStorage.setItem('facultyAppreciations', JSON.stringify(data));
}

window.renderFacultyGrid = renderFacultyGrid;
  window.updateFacultyStats = updateFacultyStats;
  window.facultyAppreciations = JSON.parse(localStorage.getItem('facultyAppreciations')) || {};

function renderFacultyGrid() {
    const container = document.getElementById('faculty-grid');
    const data = window.facultyAppreciations || {};
    const searchTerm = document.getElementById('faculty-search')?.value.toLowerCase() || '';
    
    // Get filter values
    const courseFilter = document.getElementById('faculty-course-filter')?.value || 'all';
    const cycleFilter = document.getElementById('faculty-cycle-filter')?.value || 'all';
    const dayFilter = document.getElementById('faculty-day-filter')?.value || 'all';
    
    const filteredFaculty = facultyData.filter(faculty => {
        // Search filter
        if (!faculty.name.toLowerCase().includes(searchTerm)) return false;
        
        const screenshots = data[faculty.id] || [];
        
        // If no screenshots, only show if all filters are "all"
        if (screenshots.length === 0) {
            return courseFilter === 'all' && cycleFilter === 'all' && dayFilter === 'all';
        }
        
        // Check if faculty has any screenshot matching the filters
        const hasMatchingScreenshot = screenshots.some(screenshot => {
            const courseMatch = courseFilter === 'all' || screenshot.course === courseFilter;
            const cycleMatch = cycleFilter === 'all' || screenshot.cycle === cycleFilter;
            const dayMatch = dayFilter === 'all' || screenshot.day === dayFilter;
            return courseMatch && cycleMatch && dayMatch;
        });
        
        return hasMatchingScreenshot;
    });
    
    container.innerHTML = filteredFaculty.map(faculty => {
        const screenshots = data[faculty.id] || [];
        
        // Filter screenshots based on current filters
        const filteredScreenshots = screenshots.filter(screenshot => {
            const courseMatch = courseFilter === 'all' || screenshot.course === courseFilter;
            const cycleMatch = cycleFilter === 'all' || screenshot.cycle === cycleFilter;
            const dayMatch = dayFilter === 'all' || screenshot.day === dayFilter;
            return courseMatch && cycleMatch && dayMatch;
        });
        
        const hasImages = filteredScreenshots.length > 0;
        const lastUpdate = hasImages ? getTimeSince(filteredScreenshots[filteredScreenshots.length - 1].timestamp) : 'No messages';
        
        return `
            <div onclick="openFacultyModal('${faculty.id}')" class="faculty-card glass p-6 rounded-3xl border border-slate-200/50 dark:border-white/10 card-shadow animate-fade-in-up">
                <div class="flex flex-col items-center text-center">
                    <div class="w-20 h-20 rounded-full overflow-hidden mb-4 border-4 ${hasImages ? 'border-purple-500/30' : 'border-slate-200 dark:border-white/10'}">
                        <img src="${faculty.avatar}" alt="${faculty.name}" class="w-full h-full object-cover">
                    </div>
                    <h3 class="text-sm font-extrabold text-slate-900 dark:text-white mb-1 line-clamp-2">${faculty.name.replace('Dr. ', '')}</h3>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl font-black ${hasImages ? 'text-purple-600 dark:text-purple-400' : 'text-slate-400'}">
                            ${filteredScreenshots.length}
                        </span>
                        <i data-lucide="message-circle" class="w-4 h-4 ${hasImages ? 'text-purple-500' : 'text-slate-400'}"></i>
                    </div>
                    <p class="text-xs text-slate-500 dark:text-slate-400">${lastUpdate}</p>
                    ${hasImages && isRecent(filteredScreenshots[filteredScreenshots.length - 1].timestamp) ? '<span class="mt-2 px-3 py-1 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs font-bold">ðŸ”¥ NEW</span>' : ''}
                </div>
            </div>
        `;
    }).join('');
    
    lucide.createIcons();
}

function filterFaculty() {
    renderFacultyGrid();
}
function resetFacultyFilters() {
    document.getElementById('faculty-search').value = '';
    document.getElementById('faculty-course-filter').value = 'all';
    document.getElementById('faculty-cycle-filter').value = 'all';
    document.getElementById('faculty-day-filter').value = 'all';
    renderFacultyGrid();
}

function getTimeSince(timestamp) {
    if (!timestamp) return 'Unknown';
    const now = Date.now();
    const diff = now - timestamp;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(hours / 24);
    
    if (hours < 1) return 'Just now';
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    return new Date(timestamp).toLocaleDateString();
}

function isRecent(timestamp) {
    if (!timestamp) return false;
    const now = Date.now();
    const diff = now - timestamp;
    return diff < (24 * 60 * 60 * 1000); // Less than 24 hours
}

function updateFacultyStats() {
    const data = window.facultyAppreciations || {};
    let total = 0;
    Object.values(data).forEach(screenshots => {
        total += screenshots.length;
    });
    
    const totalEl = document.getElementById('total-appreciations');
    const facultyEl = document.getElementById('total-faculty');
    
    if (totalEl) totalEl.textContent = total;
    if (facultyEl) facultyEl.textContent = facultyData.length;
}
function openFacultyModal(facultyId) {
    currentFacultyId = facultyId;
    const faculty = facultyData.find(f => f.id === facultyId);
    const data = window.facultyAppreciations || {};
    
    // Apply filters to screenshots
    const courseFilter = document.getElementById('faculty-course-filter')?.value || 'all';
    const cycleFilter = document.getElementById('faculty-cycle-filter')?.value || 'all';
    const dayFilter = document.getElementById('faculty-day-filter')?.value || 'all';
    
    let screenshots = data[facultyId] || [];
    
    // Filter screenshots based on current filters
    screenshots = screenshots.filter(screenshot => {
        const courseMatch = courseFilter === 'all' || screenshot.course === courseFilter;
        const cycleMatch = cycleFilter === 'all' || screenshot.cycle === cycleFilter;
        const dayMatch = dayFilter === 'all' || screenshot.day === dayFilter;
        return courseMatch && cycleMatch && dayMatch;
    });
    
    if (screenshots.length === 0) {
        alert('No appreciation messages for ' + faculty.name + ' matching current filters');
        return;
    }
    
    currentScreenshots = screenshots;
    currentScreenshotIndex = 0;
    bulkDeleteMode = false;
    selectedScreenshots.clear();
    
    document.getElementById('modal-faculty-avatar').src = faculty.avatar;
    document.getElementById('modal-faculty-name').textContent = faculty.name;
    document.getElementById('modal-faculty-count').textContent = `${screenshots.length} appreciation message${screenshots.length > 1 ? 's' : ''}`;
    
    // Reset views
    document.getElementById('single-view').classList.remove('hidden');
    document.getElementById('grid-view').classList.add('hidden');
    document.getElementById('bulk-delete-controls').classList.add('hidden');
    document.getElementById('carousel-dots').classList.remove('hidden');
    
    updateCarousel();
    document.getElementById('faculty-modal').classList.remove('hidden');
    
    if (state.isAdmin) {
        document.getElementById('delete-screenshot-btn').classList.remove('hidden');
        document.getElementById('bulk-delete-toggle').classList.remove('hidden');
    } else {
        document.getElementById('bulk-delete-toggle').classList.add('hidden');
    }
    
    lucide.createIcons();
}

function closeFacultyModal(event) {
    if (event && event.target !== event.currentTarget) return;
    
    // Reset bulk delete mode
    if (bulkDeleteMode) {
        exitBulkDeleteMode();
    }
    
    document.getElementById('faculty-modal').classList.add('hidden');
    currentFacultyId = null;
    currentScreenshots = [];
    currentScreenshotIndex = 0;
    selectedScreenshots.clear();
}

function updateCarousel() {
    if (currentScreenshots.length === 0) return;
    
    const screenshot = currentScreenshots[currentScreenshotIndex];
    document.getElementById('current-screenshot').src = screenshot.url;
    
    // Update dots
    const dotsContainer = document.getElementById('carousel-dots');
    dotsContainer.innerHTML = currentScreenshots.map((_, index) => `
        <button onclick="goToScreenshot(${index})" class="w-2 h-2 rounded-full transition-all ${index === currentScreenshotIndex ? 'bg-purple-500 w-6' : 'bg-slate-300 dark:bg-slate-600'}"></button>
    `).join('');
}

function nextScreenshot() {
    if (currentScreenshotIndex < currentScreenshots.length - 1) {
        currentScreenshotIndex++;
        updateCarousel();
    }
}

function prevScreenshot() {
    if (currentScreenshotIndex > 0) {
        currentScreenshotIndex--;
        updateCarousel();
    }
}

function goToScreenshot(index) {
    currentScreenshotIndex = index;
    updateCarousel();
}

function downloadScreenshot() {
    const screenshot = currentScreenshots[currentScreenshotIndex];
    const link = document.createElement('a');
    link.href = screenshot.url;
    link.download = `appreciation-${currentFacultyId}-${Date.now()}.png`;
    link.click();
}

function deleteCurrentScreenshot() {
    if (!state.isAdmin) return;
    if (!confirm('Are you sure you want to delete this screenshot?')) return;
    
    const data = window.facultyAppreciations || {};
    data[currentFacultyId].splice(currentScreenshotIndex, 1);
    
    // Save to cloud instead of local
    if (window.saveToCloud) {
        window.saveToCloud(data);
    }
    
    currentScreenshots.splice(currentScreenshotIndex, 1);
    
    if (currentScreenshots.length === 0) {
        closeFacultyModal();
    } else {
        if (currentScreenshotIndex >= currentScreenshots.length) {
            currentScreenshotIndex = currentScreenshots.length - 1;
        }
        updateCarousel();
    }
    
    renderFacultyGrid();
    updateFacultyStats();
    showToast('Screenshot deleted successfully', 'success');
}
function toggleAdminLogin() {
    document.getElementById('admin-login-modal').classList.remove('hidden');
    lucide.createIcons();
}

function closeAdminLogin(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('admin-login-modal').classList.add('hidden');
    document.getElementById('login-error').classList.add('hidden');
    document.getElementById('admin-email').value = '';
    document.getElementById('admin-password').value = '';
}

function adminLogin() {
    const email = document.getElementById('admin-email').value.trim();
    const password = document.getElementById('admin-password').value;
    
    const isValid = adminCredentials.some(cred => 
        cred.email === email && cred.password === password
    );
    
    if (isValid) {
        state.isAdmin = true;
        currentAdminEmail = email;
        closeAdminLogin();
        renderAdminPanel();
        renderFacultyGrid();
        
        // Log the login
        if (window.addLog) {
            window.addLog('Admin Login', `${email} logged in`, email);
        }
        
        const adminBtn = document.getElementById('nav-admin');
        adminBtn.setAttribute('onclick', 'adminLogout()'); 
        
        adminBtn.innerHTML = `
            <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 flex items-center justify-center transition-transform">
                <i data-lucide="shield-check" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
            </div>
            <div class="flex flex-col items-start">
                <span class="font-bold text-sm text-slate-700 dark:text-slate-300">Admin âœ“</span>
                <span class="text-[10px] text-red-500 font-black uppercase tracking-tighter">Click to Logout</span>
            </div>
        `;
        
        // Show super admin switch button
        document.getElementById('super-admin-switch').classList.remove('hidden');
        
        lucide.createIcons();
        showToast('Admin login successful!', 'success');
    } else {
        document.getElementById('login-error').classList.remove('hidden');
    }
}
function adminLogout() {
    if (!confirm('Are you sure you want to log out?')) return;

    // Log the logout
    if (window.addLog && currentAdminEmail) {
        window.addLog('Admin Logout', `${currentAdminEmail} logged out`, currentAdminEmail);
    }

    state.isAdmin = false;
    isSuperAdmin = false;
    currentAdminEmail = '';
    
    const adminBtn = document.getElementById('nav-admin');
    adminBtn.setAttribute('onclick', 'toggleAdminLogin()'); 
    
    adminBtn.className = "flex items-center gap-3 w-full px-4 py-3 rounded-xl border border-slate-200/80 dark:border-white/[0.08] hover:border-amber-500/50 dark:hover:border-amber-500/50 hover:bg-amber-50 dark:hover:bg-amber-500/10 transition-all duration-300 group";
    
    adminBtn.innerHTML = `
        <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-amber-100 to-orange-100 dark:from-amber-900/30 dark:to-orange-900/30 flex items-center justify-center group-hover:scale-110 transition-transform">
            <i data-lucide="shield-check" class="w-4 h-4 text-amber-600 dark:text-amber-400"></i>
        </div>
        <span class="sidebar-label font-bold text-sm text-slate-700 dark:text-slate-300">Admin Access</span>
    `;

    // Hide super admin elements
    document.getElementById('super-admin-switch').classList.add('hidden');
    document.getElementById('super-admin-panel').classList.add('hidden');
    
    const uploadPanel = document.getElementById('admin-upload-panel');
    const managementPanel = document.getElementById('admin-management-panel');
    if (uploadPanel) uploadPanel.classList.add('hidden');
    if (managementPanel) managementPanel.classList.add('hidden');
    
    lucide.createIcons();
    renderFacultyGrid();
    updateFacultyStats();
    showToast('Admin Logout successful!', 'success');
}
// ========== SUPER ADMIN FUNCTIONS ==========

function toggleSuperAdmin() {
    if (!state.isAdmin) return;
    
    // Check if current admin is a super admin
    if (superAdmins.includes(currentAdminEmail)) {
        isSuperAdmin = !isSuperAdmin;
        
        const panel = document.getElementById('super-admin-panel');
        const switchBtn = document.getElementById('super-admin-switch');
        
        if (isSuperAdmin) {
            panel.classList.remove('hidden');
            switchBtn.classList.add('bg-orange-100', 'dark:bg-orange-900/30', 'border-orange-500');
            
            if (window.addLog) {
                window.addLog('Super Admin Access', `${currentAdminEmail} enabled super admin mode`, currentAdminEmail);
            }
            
            showToast('Super Admin mode activated', 'success');
        } else {
            panel.classList.add('hidden');
            switchBtn.classList.remove('bg-orange-100', 'dark:bg-orange-900/30', 'border-orange-500');
            showToast('Super Admin mode deactivated', 'success');
        }
        
        lucide.createIcons();
    } else {
        showToast('Access Denied: You are not a super admin', 'error');
    }
}

function addAdminCredential() {
    if (!isSuperAdmin) {
        showToast('Access Denied: Super admin only', 'error');
        return;
    }
    
    const email = document.getElementById('new-admin-email').value.trim();
    const password = document.getElementById('new-admin-password').value;
    
    if (!email || !password) {
        showToast('Please enter both email and password', 'error');
        return;
    }
    
    if (!email.includes('@')) {
        showToast('Please enter a valid email', 'error');
        return;
    }
    
    if (adminCredentials.find(c => c.email === email)) {
        showToast('Admin already exists', 'error');
        return;
    }
    
    adminCredentials.push({ email, password });
    
    if (window.saveAdminCredentialsToCloud) {
        window.saveAdminCredentialsToCloud(adminCredentials);
    }
    
    localStorage.setItem('adminCredentials', JSON.stringify(adminCredentials));
    
    if (window.addLog) {
        window.addLog('Admin Created', `New admin created: ${email}`, currentAdminEmail);
    }
    
    document.getElementById('new-admin-email').value = '';
    document.getElementById('new-admin-password').value = '';
    
    showToast('Admin added successfully', 'success');
}

function showDeleteAdminModal() {
    if (!isSuperAdmin) {
        showToast('Access Denied: Super admin only', 'error');
        return;
    }
    
    const modal = document.getElementById('delete-admin-modal');
    const select = document.getElementById('delete-admin-select');
    
    select.innerHTML = '<option value="">Choose admin...</option>' + 
        adminCredentials.map(c => `<option value="${c.email}">${c.email}</option>`).join('');
    
    modal.classList.remove('hidden');
    lucide.createIcons();
}

function closeDeleteAdminModal() {
    document.getElementById('delete-admin-modal').classList.add('hidden');
}

function confirmDeleteAdmin() {
    const select = document.getElementById('delete-admin-select');
    const email = select.value;
    
    if (!email) {
        showToast('Please select an admin', 'error');
        return;
    }
    
    if (superAdmins.includes(email)) {
        showToast('Cannot delete super admin', 'error');
        return;
    }
    
    if (!confirm(`Remove admin: ${email}?`)) return;
    
    const index = adminCredentials.findIndex(c => c.email === email);
    adminCredentials.splice(index, 1);
    
    if (window.saveAdminCredentialsToCloud) {
        window.saveAdminCredentialsToCloud(adminCredentials);
    }
    
    localStorage.setItem('adminCredentials', JSON.stringify(adminCredentials));
    
    if (window.addLog) {
        window.addLog('Admin Deleted', `Admin removed: ${email}`, currentAdminEmail);
    }
    
    closeDeleteAdminModal();
    showToast('Admin removed successfully', 'success');
}

async function viewActivityLogs() {
    if (!isSuperAdmin) {
        showToast('Access Denied: Super admin only', 'error');
        return;
    }
    
    const modal = document.getElementById('activity-logs-modal');
    const container = document.getElementById('logs-container');
    
    container.innerHTML = `
        <div class="flex items-center justify-center p-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
        </div>
    `;
    
    modal.classList.remove('hidden');
    
    if (window.loadLogs) {
        const logs = await window.loadLogs();
        
        if (logs.length === 0) {
            container.innerHTML = `
                <div class="text-center p-8 text-slate-500">
                    No activity logs found
                </div>
            `;
        } else {
            container.innerHTML = logs.map(log => {
                const date = new Date(log.timestamp);
                return `
                    <div class="p-4 mb-3 rounded-xl border border-slate-200 dark:border-white/10 bg-white/50 dark:bg-white/5 hover:bg-purple-50 dark:hover:bg-purple-900/10 transition-all">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i data-lucide="${getLogIcon(log.action)}" class="w-4 h-4 ${getLogColor(log.action)}"></i>
                                <span class="font-bold text-sm text-slate-900 dark:text-white">${log.action}</span>
                            </div>
                            <span class="text-xs text-slate-500 dark:text-slate-400">${date.toLocaleString()}</span>
                        </div>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-1">${log.details}</p>
                        <p class="text-xs text-purple-600 dark:text-purple-400 font-semibold">By: ${log.adminEmail}</p>
                    </div>
                `;
            }).join('');
        }
    }
    
    lucide.createIcons();
}

function closeActivityLogs() {
    document.getElementById('activity-logs-modal').classList.add('hidden');
}

function getLogIcon(action) {
    if (action.includes('Login')) return 'log-in';
    if (action.includes('Logout')) return 'log-out';
    if (action.includes('Upload')) return 'upload';
    if (action.includes('Delete')) return 'trash-2';
    if (action.includes('Created')) return 'plus-circle';
    if (action.includes('Super Admin')) return 'shield-alert';
    return 'activity';
}

function getLogColor(action) {
    if (action.includes('Login')) return 'text-green-500';
    if (action.includes('Logout')) return 'text-orange-500';
    if (action.includes('Delete')) return 'text-red-500';
    if (action.includes('Upload') || action.includes('Created')) return 'text-blue-500';
    if (action.includes('Super Admin')) return 'text-purple-500';
    return 'text-slate-500';
}

function renderAdminPanel() {
    const uploadPanel = document.getElementById('admin-upload-panel');
    const managementPanel = document.getElementById('admin-management-panel');
    
    if (state.isAdmin) {
        uploadPanel.classList.remove('hidden');
        managementPanel.classList.remove('hidden');
        
        const select = document.getElementById('admin-faculty-select');
        if (select) {
            select.innerHTML = '<option value="">Choose faculty...</option>' + 
                facultyData.map(faculty => `<option value="${faculty.id}">${faculty.name}</option>`).join('');
        }
        
        const fileInput = document.getElementById('admin-image-upload');
        if (fileInput) {
            // Remove old event listener and add fresh one
            fileInput.onchange = null;
            
            fileInput.onchange = function(e) {
                const preview = document.getElementById('upload-preview');
                const container = document.getElementById('preview-container');
                
                console.log('File input changed, files:', this.files.length); // Debug log
                
                if (this.files && this.files.length > 0) {
                    preview.classList.remove('hidden');
                    container.innerHTML = '';
                    
                    Array.from(this.files).forEach((file, index) => {
                        console.log('Processing file', index + 1, ':', file.name); // Debug log
                        
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            container.innerHTML += `
                                <div class="relative rounded-xl overflow-hidden border-2 border-purple-500/30">
                                    <img src="${e.target.result}" class="w-full h-32 object-cover">
                                    <div class="absolute bottom-0 left-0 right-0 bg-black/50 p-1">
                                        <p class="text-white text-xs truncate">${file.name}</p>
                                    </div>
                                </div>
                            `;
                        };
                        reader.onerror = (err) => {
                            console.error('Error reading file:', err);
                        };
                        reader.readAsDataURL(file);
                    });
                } else {
                    preview.classList.add('hidden');
                    container.innerHTML = '';
                }
            };
        }
    } else {
        uploadPanel.classList.add('hidden');
        managementPanel.classList.add('hidden');
    }
    lucide.createIcons();
}

// function toggleAdminLogin() {
//     document.getElementById('admin-login-modal').classList.remove('hidden');
//     lucide.createIcons();
// }

function closeAdminLogin(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('admin-login-modal').classList.add('hidden');
    document.getElementById('login-error').classList.add('hidden');
    document.getElementById('admin-email').value = '';
    document.getElementById('admin-password').value = '';
}


function uploadImages() {
    const faculty = document.getElementById('admin-faculty-select').value;
    const fileInput = document.getElementById('admin-image-upload');
    const course = document.getElementById('admin-course-select').value;
    const cycle = document.getElementById('admin-cycle-select').value;
    const day = document.getElementById('admin-day-select').value;
    
    // Validation
    if (!faculty) {
        showToast('Please select a faculty', 'error');
        return;
    }
    
    if (!course) {
        showToast('Please select a course', 'error');
        return;
    }
    
    if (!cycle) {
        showToast('Please select a cycle', 'error');
        return;
    }
    
    if (!day) {
        showToast('Please select a day', 'error');
        return;
    }
    
    if (!fileInput.files.length) {
        showToast('Please select images to upload', 'error');
        return;
    }
    
    const data = window.facultyAppreciations || {};
    if (!data[faculty]) data[faculty] = [];
    
    let uploaded = 0;
    const totalFiles = fileInput.files.length;
    
    Array.from(fileInput.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            data[faculty].push({
                url: e.target.result,
                timestamp: Date.now(),
                course: course,
                cycle: cycle,
                day: day
            });
            uploaded++;
            
            if (uploaded === totalFiles) {
                // Save to cloud
                if (window.saveToCloud) {
                    window.saveToCloud(data);
                }
                
                // Log the upload
                if (window.addLog && currentAdminEmail) {
                    window.addLog('Screenshots Uploaded', `${uploaded} screenshot(s) uploaded for ${faculty}`, currentAdminEmail);
                }
                
                // Clear the form properly
                const previewContainer = document.getElementById('preview-container');
                if (previewContainer) {
                    previewContainer.innerHTML = '';
                }
                
                document.getElementById('upload-preview').classList.add('hidden');
                document.getElementById('admin-faculty-select').value = '';
                document.getElementById('admin-course-select').value = '';
                document.getElementById('admin-cycle-select').value = '';
                document.getElementById('admin-day-select').value = '';
                
                // Reset file input properly
                fileInput.value = '';
                
                // Force re-render of admin panel to reset file input event
                renderAdminPanel();
                
                renderFacultyGrid();
                updateFacultyStats();
                showToast(`${uploaded} screenshot(s) uploaded successfully!`, 'success');
            }
        };
        reader.readAsDataURL(file);
    });
}

function deleteImage(faculty, index) {
    if (!confirm('Are you sure you want to delete this image?')) return;
    
    const data = getFacultyData();
    data[faculty].splice(index, 1);
    saveFacultyData(data);
    renderFacultyChips();
    renderGallery();
}
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    
    // Set colors based on type
    const bgColor = type === 'success' ? 'bg-emerald-500' : 'bg-red-500';
    const icon = type === 'success' ? 'check-circle' : 'alert-circle';

    toast.className = `${bgColor} text-white px-6 py-4 rounded-2xl shadow-lg flex items-center gap-3 toast-animate pointer-events-auto`;
    toast.innerHTML = `
        <i data-lucide="${icon}" class="w-5 h-5"></i>
        <span class="font-bold text-sm">${message}</span>
    `;

    container.appendChild(toast);
    lucide.createIcons();

    // Automatically remove toast after animation finishes
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
// Load saved theme preference
function loadThemePreference() {
    const savedTheme = localStorage.getItem('theme');
    
    if (savedTheme === 'dark') {
        state.isDark = true;
        document.documentElement.classList.add('dark');
        const icon = document.getElementById('theme-icon');
        const text = document.getElementById('theme-text');
        if (icon) icon.setAttribute('data-lucide', 'moon');
        if (text) text.innerText = 'Dark Mode';
    } else {
        state.isDark = false;
        document.documentElement.classList.remove('dark');
        const icon = document.getElementById('theme-icon');
        const text = document.getElementById('theme-text');
        if (icon) icon.setAttribute('data-lucide', 'sun');
        if (text) text.innerText = 'Light Mode';
    }
    
    lucide.createIcons();
}
// ========== ADMIN MANAGEMENT FUNCTIONS ==========

// Store options in localStorage
let adminCourses = JSON.parse(localStorage.getItem('adminCourses')) || ['NEET PG', 'FMGE', 'OneShot'];
let adminCycles = JSON.parse(localStorage.getItem('adminCycles')) || ['Cycle 1', 'Cycle 2'];
let adminDays = JSON.parse(localStorage.getItem('adminDays')) || Array.from({length: 15}, (_, i) => `Day ${i + 1}`);

function saveAdminOptions() {
    localStorage.setItem('adminCourses', JSON.stringify(adminCourses));
    localStorage.setItem('adminCycles', JSON.stringify(adminCycles));
    localStorage.setItem('adminDays', JSON.stringify(adminDays));
    
    // Save to Firebase
    if (window.saveAdminOptionsToCloud) {
        window.saveAdminOptionsToCloud(adminCourses, adminCycles, adminDays);
    }
    
    updateAllDropdowns();
}

function updateAllDropdowns() {
    // Update upload dropdowns
    const courseSelect = document.getElementById('admin-course-select');
    if (courseSelect) {
        const current = courseSelect.value;
        courseSelect.innerHTML = '<option value="">Select course...</option>' + 
            adminCourses.map(c => `<option value="${c}">${c}</option>`).join('');
        courseSelect.value = current;
    }
    
    const cycleSelect = document.getElementById('admin-cycle-select');
    if (cycleSelect) {
        const current = cycleSelect.value;
        cycleSelect.innerHTML = '<option value="">Select cycle...</option>' + 
            adminCycles.map(c => `<option value="${c}">${c}</option>`).join('');
        cycleSelect.value = current;
    }
    
    const daySelect = document.getElementById('admin-day-select');
    if (daySelect) {
        const current = daySelect.value;
        daySelect.innerHTML = '<option value="">Select day...</option>' + 
            adminDays.map(d => `<option value="${d}">${d}</option>`).join('');
        daySelect.value = current;
    }
    
    // Update filter dropdowns
    const courseFilter = document.getElementById('faculty-course-filter');
    if (courseFilter) {
        const current = courseFilter.value;
        courseFilter.innerHTML = '<option value="all">All Courses</option>' + 
            adminCourses.map(c => `<option value="${c}">${c}</option>`).join('');
        courseFilter.value = current;
    }
    
    const cycleFilter = document.getElementById('faculty-cycle-filter');
    if (cycleFilter) {
        const current = cycleFilter.value;
        cycleFilter.innerHTML = '<option value="all">All Cycles</option>' + 
            adminCycles.map(c => `<option value="${c}">${c}</option>`).join('');
        cycleFilter.value = current;
    }
    
    const dayFilter = document.getElementById('faculty-day-filter');
    if (dayFilter) {
        const current = dayFilter.value;
        dayFilter.innerHTML = '<option value="all">All Days</option>' + 
            adminDays.map(d => `<option value="${d}">${d}</option>`).join('');
        dayFilter.value = current;
    }
}

// Faculty Management
function addFaculty() {
    const input = document.getElementById('new-faculty-name');
    const name = input.value.trim();
    
    if (!name) {
        showToast('Please enter a faculty name', 'error');
        return;
    }
    
    if (!name.startsWith('Dr. ')) {
        showToast('Faculty name must start with "Dr. "', 'error');
        return;
    }
    
    const id = name.toLowerCase().replace(/\s+/g, '-').replace(/\./g, '');
    
    if (facultyData.find(f => f.id === id)) {
        showToast('Faculty already exists', 'error');
        return;
    }
    
    facultyData.push({
        id: id,
        name: name,
        avatar: `https://api.dicebear.com/7.x/notionists/svg?seed=${name}`
    });
    
    // Save to Firebase (not just localStorage)
    if (window.saveFacultyListToCloud) {
        window.saveFacultyListToCloud(facultyData);
    }
    // Log the creation
    if (window.addLog && currentAdminEmail) {
        window.addLog('Faculty Created', `New faculty added: ${name}`, currentAdminEmail);
    }
    
    input.value = '';
    renderFacultyGrid();
    renderAdminPanel();
    showToast('Faculty added successfully', 'success');
}

function showDeleteFacultyModal() {
    const modal = document.getElementById('delete-faculty-modal');
    const select = document.getElementById('delete-faculty-select');
    
    select.innerHTML = '<option value="">Choose faculty...</option>' + 
        facultyData.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
    
    modal.classList.remove('hidden');
    lucide.createIcons();
}

function closeDeleteFacultyModal() {
    document.getElementById('delete-faculty-modal').classList.add('hidden');
}

function confirmDeleteFaculty() {
    const select = document.getElementById('delete-faculty-select');
    const id = select.value;
    
    if (!id) {
        showToast('Please select a faculty', 'error');
        return;
    }
    
    const faculty = facultyData.find(f => f.id === id);
    
    if (!confirm(`Delete ${faculty.name} and all their screenshots?`)) return;
    
    // Remove from faculty list
    const index = facultyData.findIndex(f => f.id === id);
    facultyData.splice(index, 1);
    
    // Save updated list to Firebase
    if (window.saveFacultyListToCloud) {
        window.saveFacultyListToCloud(facultyData);
    }
     // Log the deletion
    if (window.addLog && currentAdminEmail) {
        window.addLog('Screenshot Deleted', `Screenshot deleted for ${currentFacultyId}`, currentAdminEmail);
    }
    
    // Remove their screenshots
    const data = window.facultyAppreciations || {};
    delete data[id];
    if (window.saveToCloud) {
        window.saveToCloud(data);
    }
     // Log the deletion
    if (window.addLog && currentAdminEmail) {
        window.addLog('Faculty Deleted', `Faculty deleted: ${faculty.name}`, currentAdminEmail);
    }
    
    closeDeleteFacultyModal();
    renderFacultyGrid();
    renderAdminPanel();
    updateFacultyStats();
    showToast('Faculty deleted successfully', 'success');
}

// Course Management
function addCourse() {
    const input = document.getElementById('new-course-name');
    const name = input.value.trim();
    
    if (!name) {
        showToast('Please enter a course name', 'error');
        return;
    }
    
    if (adminCourses.includes(name)) {
        showToast('Course already exists', 'error');
        return;
    }
    
    adminCourses.push(name);
    saveAdminOptions();
    if (window.addLog && currentAdminEmail) {
        window.addLog('Course Deleted', `Course deleted: ${course}`, currentAdminEmail);
    }
    input.value = '';
    showToast('Course added successfully', 'success');
}

function showDeleteCourseModal() {
    const modal = document.getElementById('delete-course-modal');
    const select = document.getElementById('delete-course-select');
    
    select.innerHTML = '<option value="">Choose course...</option>' + 
        adminCourses.map(c => `<option value="${c}">${c}</option>`).join('');
    
    modal.classList.remove('hidden');
}

function closeDeleteCourseModal() {
    document.getElementById('delete-course-modal').classList.add('hidden');
}

function confirmDeleteCourse() {
    const select = document.getElementById('delete-course-select');
    const course = select.value;
    
    if (!course) {
        showToast('Please select a course', 'error');
        return;
    }
    
    if (!confirm(`Delete course "${course}"?`)) return;
    
    const index = adminCourses.indexOf(course);
    adminCourses.splice(index, 1);
    saveAdminOptions();
    if (window.addLog && currentAdminEmail) {
        window.addLog('Course Deleted', `Course deleted: ${course}`, currentAdminEmail);
    }
    closeDeleteCourseModal();
    showToast('Course deleted successfully', 'success');
}

// Cycle Management
function addCycle() {
    const input = document.getElementById('new-cycle-name');
    const name = input.value.trim();
    
    if (!name) {
        showToast('Please enter a cycle name', 'error');
        return;
    }
    
    if (adminCycles.includes(name)) {
        showToast('Cycle already exists', 'error');
        return;
    }
    
    adminCycles.push(name);
    saveAdminOptions();
    if (window.addLog && currentAdminEmail) {
        window.addLog('Cycle Created', `New cycle added: ${name}`, currentAdminEmail);
    }
    input.value = '';
    showToast('Cycle added successfully', 'success');
}

function showDeleteCycleModal() {
    const modal = document.getElementById('delete-cycle-modal');
    const select = document.getElementById('delete-cycle-select');
    
    select.innerHTML = '<option value="">Choose cycle...</option>' + 
        adminCycles.map(c => `<option value="${c}">${c}</option>`).join('');
    
    modal.classList.remove('hidden');
}

function closeDeleteCycleModal() {
    document.getElementById('delete-cycle-modal').classList.add('hidden');
}

function confirmDeleteCycle() {
    const select = document.getElementById('delete-cycle-select');
    const cycle = select.value;
    
    if (!cycle) {
        showToast('Please select a cycle', 'error');
        return;
    }
    
    if (!confirm(`Delete cycle "${cycle}"?`)) return;
    
    const index = adminCycles.indexOf(cycle);
    adminCycles.splice(index, 1);
    saveAdminOptions();
    if (window.addLog && currentAdminEmail) {
        window.addLog('Cycle Deleted', `Cycle deleted: ${cycle}`, currentAdminEmail);
    }
    closeDeleteCycleModal();
    showToast('Cycle deleted successfully', 'success');
}

// Day Management
function addDay() {
    const input = document.getElementById('new-day-number');
    const num = parseInt(input.value);
    
    if (!num || num < 1) {
        showToast('Please enter a valid day number', 'error');
        return;
    }
    
    const name = `Day ${num}`;
    
    if (adminDays.includes(name)) {
        showToast('Day already exists', 'error');
        return;
    }
    
    adminDays.push(name);
    adminDays.sort((a, b) => {
        const numA = parseInt(a.replace('Day ', ''));
        const numB = parseInt(b.replace('Day ', ''));
        return numA - numB;
    });
    saveAdminOptions();
    if (window.addLog && currentAdminEmail) {
        window.addLog('Day Created', `New day added: ${name}`, currentAdminEmail);
    }
    input.value = '';
    showToast('Day added successfully', 'success');
}

function showDeleteDayModal() {
    const modal = document.getElementById('delete-day-modal');
    const select = document.getElementById('delete-day-select');
    
    select.innerHTML = '<option value="">Choose day...</option>' + 
        adminDays.map(d => `<option value="${d}">${d}</option>`).join('');
    
    modal.classList.remove('hidden');
}

function closeDeleteDayModal() {
    document.getElementById('delete-day-modal').classList.add('hidden');
}

function confirmDeleteDay() {
    const select = document.getElementById('delete-day-select');
    const day = select.value;
    
    if (!day) {
        showToast('Please select a day', 'error');
        return;
    }
    
    if (!confirm(`Delete "${day}"?`)) return;
    
    const index = adminDays.indexOf(day);
    adminDays.splice(index, 1);
    saveAdminOptions();
    if (window.addLog && currentAdminEmail) {
        window.addLog('Day Deleted', `Day deleted: ${day}`, currentAdminEmail);
    }
    closeDeleteDayModal();
    showToast('Day deleted successfully', 'success');
}
// ========== BULK DELETE FUNCTIONS ==========

let bulkDeleteMode = false;
let selectedScreenshots = new Set();

function toggleBulkDeleteMode() {
    bulkDeleteMode = !bulkDeleteMode;
    
    if (bulkDeleteMode) {
        enterBulkDeleteMode();
    } else {
        exitBulkDeleteMode();
    }
}

function enterBulkDeleteMode() {
    // Show bulk delete controls
    document.getElementById('bulk-delete-controls').classList.remove('hidden');
    
    // Hide single view, show grid view
    document.getElementById('single-view').classList.add('hidden');
    document.getElementById('grid-view').classList.remove('hidden');
    
    // Hide carousel dots and single delete button
    document.getElementById('carousel-dots').classList.add('hidden');
    document.getElementById('delete-screenshot-btn').classList.add('hidden');
    
    // Update toggle button
    const toggleBtn = document.getElementById('bulk-delete-toggle');
    toggleBtn.innerHTML = `
        <i data-lucide="x" class="w-4 h-4 inline mr-1"></i>
        Cancel Selection
    `;
    toggleBtn.classList.add('bg-purple-100', 'dark:bg-purple-900/30');
    
    // Render grid
    renderScreenshotGrid();
    
    lucide.createIcons();
}

function exitBulkDeleteMode() {
    bulkDeleteMode = false;
    selectedScreenshots.clear();
    
    // Hide bulk delete controls
    document.getElementById('bulk-delete-controls').classList.add('hidden');
    
    // Show single view, hide grid view
    document.getElementById('single-view').classList.remove('hidden');
    document.getElementById('grid-view').classList.add('hidden');
    
    // Show carousel dots and single delete button
    document.getElementById('carousel-dots').classList.remove('hidden');
    if (state.isAdmin) {
        document.getElementById('delete-screenshot-btn').classList.remove('hidden');
    }
    
    // Update toggle button
    const toggleBtn = document.getElementById('bulk-delete-toggle');
    toggleBtn.innerHTML = `
        <i data-lucide="check-square" class="w-4 h-4 inline mr-1"></i>
        Select Multiple
    `;
    toggleBtn.classList.remove('bg-purple-100', 'dark:bg-purple-900/30');
    
    // Uncheck select all
    document.getElementById('select-all-checkbox').checked = false;
    
    lucide.createIcons();
}

function renderScreenshotGrid() {
    const grid = document.getElementById('screenshot-grid');
    
    grid.innerHTML = currentScreenshots.map((screenshot, index) => `
        <div class="relative group">
            <div class="relative rounded-xl overflow-hidden border-2 ${selectedScreenshots.has(index) ? 'border-purple-500 ring-4 ring-purple-500/30' : 'border-slate-200 dark:border-white/10'} transition-all">
                <img src="${screenshot.url}" class="w-full h-40 object-cover cursor-pointer" onclick="toggleScreenshotSelection(${index})">
                
                <!-- Checkbox Overlay -->
                <div class="absolute top-2 right-2">
                    <input type="checkbox" 
                        ${selectedScreenshots.has(index) ? 'checked' : ''} 
                        onchange="toggleScreenshotSelection(${index})" 
                        class="w-6 h-6 rounded border-2 border-white shadow-lg text-purple-600 focus:ring-purple-500 cursor-pointer">
                </div>
                
                <!-- Info Overlay -->
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-2">
                    <p class="text-white text-xs font-bold">${screenshot.course || 'N/A'}</p>
                    <p class="text-white text-xs">${screenshot.cycle || 'N/A'} â€¢ ${screenshot.day || 'N/A'}</p>
                </div>
            </div>
        </div>
    `).join('');
}

function toggleScreenshotSelection(index) {
    if (selectedScreenshots.has(index)) {
        selectedScreenshots.delete(index);
    } else {
        selectedScreenshots.add(index);
    }
    
    updateBulkDeleteUI();
    renderScreenshotGrid();
}

function toggleSelectAll() {
    const checkbox = document.getElementById('select-all-checkbox');
    
    if (checkbox.checked) {
        // Select all
        selectedScreenshots.clear();
        currentScreenshots.forEach((_, index) => {
            selectedScreenshots.add(index);
        });
    } else {
        // Deselect all
        selectedScreenshots.clear();
    }
    
    updateBulkDeleteUI();
    renderScreenshotGrid();
}

function updateBulkDeleteUI() {
    const count = selectedScreenshots.size;
    const countEl = document.getElementById('selected-count');
    const deleteBtn = document.getElementById('bulk-delete-btn');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    
    countEl.textContent = `${count} selected`;
    deleteBtn.disabled = count === 0;
    
    // Update select all checkbox state
    if (count === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (count === currentScreenshots.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

function cancelBulkDelete() {
    exitBulkDeleteMode();
}

function confirmBulkDelete() {
    const count = selectedScreenshots.size;
    
    if (count === 0) {
        showToast('No screenshots selected', 'error');
        return;
    }
    
    if (!confirm(`Delete ${count} screenshot${count > 1 ? 's' : ''}?`)) return;
    
    // Convert Set to Array and sort in reverse order (delete from end to start)
    const indicesToDelete = Array.from(selectedScreenshots).sort((a, b) => b - a);
    
    const data = window.facultyAppreciations || {};
    
    // Delete each selected screenshot
    indicesToDelete.forEach(index => {
        data[currentFacultyId].splice(index, 1);
        currentScreenshots.splice(index, 1);
    });
    
    // Save to cloud
    if (window.saveToCloud) {
        window.saveToCloud(data);
    }
    // Log bulk deletion
    if (window.addLog && currentAdminEmail) {
        window.addLog('Bulk Delete', `${count} screenshot(s) deleted for ${currentFacultyId}`, currentAdminEmail);
    }
    
    // Reset selection
    selectedScreenshots.clear();
    
    // Check if any screenshots remain
    if (currentScreenshots.length === 0) {
        closeFacultyModal();
        showToast(`${count} screenshot${count > 1 ? 's' : ''} deleted successfully`, 'success');
    } else {
        // Update UI
        exitBulkDeleteMode();
        currentScreenshotIndex = 0;
        updateCarousel();
        document.getElementById('modal-faculty-count').textContent = `${currentScreenshots.length} appreciation message${currentScreenshots.length > 1 ? 's' : ''}`;
        showToast(`${count} screenshot${count > 1 ? 's' : ''} deleted successfully`, 'success');
    }
    
    renderFacultyGrid();
    updateFacultyStats();
}


    window.onload = async () => {
    loadThemePreference();
    renderKPIs();
    
    // Upload existing localStorage data to Firebase (one-time migration)
    const existingFacultyData = localStorage.getItem('facultyData');
    if (existingFacultyData && window.saveFacultyListToCloud) {
        const parsed = JSON.parse(existingFacultyData);
        await window.saveFacultyListToCloud(parsed);
        console.log("ðŸ“¤ Migrated faculty data to Firebase");
    }
    
    const existingCourses = localStorage.getItem('adminCourses');
    const existingCycles = localStorage.getItem('adminCycles');
    const existingDays = localStorage.getItem('adminDays');
    
    if (existingCourses && existingCycles && existingDays && window.saveAdminOptionsToCloud) {
        await window.saveAdminOptionsToCloud(
            JSON.parse(existingCourses),
            JSON.parse(existingCycles),
            JSON.parse(existingDays)
        );
        console.log("ðŸ“¤ Migrated admin options to Firebase");
    }
    
    await loadSheet();
    
    // Load saved faculty data if exists
    const savedFacultyData = localStorage.getItem('facultyData');
    if (savedFacultyData) {
        facultyData = JSON.parse(savedFacultyData);
    }
    
    updateAllDropdowns();
    lucide.createIcons();
};
   let lastScroll = window.scrollY;

setInterval(() => {
    lastScroll = window.scrollY;
    loadSheet();
    setTimeout(() => {
        window.scrollTo(0, lastScroll);
    }, 200);
}, 450000);



</script>
<div id="toast-container" class="fixed bottom-5 right-5 z-[1000] flex flex-col gap-3 pointer-events-none"></div>

<style>
    .toast-animate {
        animation: toast-in 0.3s ease forwards, toast-out 0.3s ease forwards 2.7s;
    }
    @keyframes toast-in {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes toast-out {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
</style>

</body>

</html>